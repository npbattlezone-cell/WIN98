<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles --- */
        :root {
            --primary-bg: #0F172A; /* Dark blue-gray */
            --secondary-bg: #1E293B; /* Slightly lighter blue-gray */
            --card-bg: #1E293B;
            --text-primary: #E2E8F0; /* Light gray for primary text */
            --text-secondary: #94A3B8; /* Muted gray for secondary text */
            --accent-color: #FACC15; /* Yellow accent */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue for primary actions */
            --border-color: #334155; /* Border color */
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981; /* Green for success */
            --danger-color: #EF4444; /* Red for danger/errors */
            --warning-color: #F59E0B; /* Orange for warnings */
            --info-color: #3B82F6; /* Blue for info */
            --login-purple-gradient: linear-gradient(135deg, #6B21A8, #A21CAF);
        }
        
        /* NEW FIX: Forcefully prevent horizontal scroll and bounce effect */
        html, body {
            overflow-x: hidden;
            overscroll-behavior-x: none;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        /* MODIFIED: Removed overflow-x and overscroll-behavior-x from here */
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary-bg); color: var(--text-primary); padding-top: 70px; padding-bottom: 75px; min-height: 100vh; overscroll-behavior-y: contain; transition: background-color 0.3s, padding 0.3s; }
        a { color: var(--accent-color); text-decoration: none; } a:hover { color: #FBBF24; }
        .main-content { padding: 15px; } .section { display: none; animation: fadeIn 0.3s ease-in-out; } .section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to: { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); } .custom-card { background-color: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); } .btn-custom { border-radius: 6px; font-size: 0.9rem; font-weight: 500; padding: 10px 15px; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s ease-out; } .btn-custom-primary { background-color: var(--primary-button-bg); color: var(--text-primary); } .btn-custom-primary:hover { background-color: #2563EB; filter: brightness(1.1); } .btn-custom-secondary { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .btn-custom-secondary:hover { background-color: #334155; } .btn-custom-accent { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; } .btn-custom-accent:hover { filter: brightness(1.1); } .btn-custom:active { transform: scale(0.97); filter: brightness(0.95); } .btn-custom-link { background: none; border: none; color: var(--primary-button-bg); font-size: 0.9rem; font-weight: 500; padding: 0; cursor: pointer; } .text-accent { color: var(--accent-color); } .text-success { color: var(--success-color); } .text-danger { color: var(--danger-color); } .text-warning { color: var(--warning-color); } .form-control { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; } .form-control:focus { background-color: var(--primary-bg); border-color: var(--accent-color); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); } .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; } .form-label { color: var(--text-secondary); font-size: 0.9rem; } .alert { border-radius: 6px; font-size: 0.9rem; }

        /* MODIFIED LIST GROUP ITEM FOR CONSISTENT BORDERS */
        .list-group-item {
            background-color: transparent;
            color: var(--text-primary);
            border: none; /* Remove all default borders */
            padding: 15px;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
        }
        .list-group-item:not(:first-child) {
            border-top: 1px solid var(--border-color); /* Add a top border to all items EXCEPT the first one */
        }
        .list-group-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .list-group-item i:first-child { color: var(--accent-color); margin-right: 15px; font-size: 1.1rem; width: 20px; text-align: center; }
        .list-group-item .bi-chevron-right { color: var(--text-secondary); font-size: 0.9rem; }


        /* =========== PREMIUM ANIMATED LOADER STYLES START =========== */
        @keyframes animated-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            10%, 90% { opacity: 0.3; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }
        /* NEW Animation for icons floating down */
        @keyframes floatDown {
            0% { transform: translateY(0); opacity: 0; }
            10%, 90% { opacity: 0.3; }
            100% { transform: translateY(100vh); opacity: 0; }
        }

        #globalLoaderEl {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; /* === FIXED: Changed from 'none' to 'flex' === */
            justify-content: center;
            align-items: center;
            z-index: 9999;
            background: linear-gradient(-45deg, #0f172a, #1a0a36, #3b216b, #4a0e4e);
            background-size: 400% 400%;
            animation: animated-gradient 15s ease infinite;
            overflow: hidden; /* Hide overflowing icons */
        }

        /* --- Background Icons --- */
        .loader-icons-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .loader-icons-bg i {
            position: absolute;
            color: var(--accent-color);
            font-size: 2rem;
            opacity: 0;
        }

        /* Icons floating UP */
        .loader-icons-bg i:nth-child(1),
        .loader-icons-bg i:nth-child(2),
        .loader-icons-bg i:nth-child(3),
        .loader-icons-bg i:nth-child(4),
        .loader-icons-bg i:nth-child(5),
        .loader-icons-bg i:nth-child(6) {
            animation: floatUp 10s infinite ease-in-out;
            bottom: -50px;
        }
        .loader-icons-bg i:nth-child(1) { left: 10%; animation-duration: 12s; animation-delay: 0s; }
        .loader-icons-bg i:nth-child(2) { left: 30%; animation-duration: 15s; animation-delay: 2s; font-size: 1.5rem; }
        .loader-icons-bg i:nth-child(3) { left: 55%; animation-duration: 10s; animation-delay: 4s; }
        .loader-icons-bg i:nth-child(4) { left: 75%; animation-duration: 14s; animation-delay: 1s; font-size: 2.5rem; }
        .loader-icons-bg i:nth-child(5) { left: 90%; animation-duration: 11s; animation-delay: 3s; color: var(--success-color); }
        .loader-icons-bg i:nth-child(6) { left: 20%; animation-duration: 13s; animation-delay: 5s; }

        /* Icons floating DOWN */
        .loader-icons-bg i:nth-child(7),
        .loader-icons-bg i:nth-child(8),
        .loader-icons-bg i:nth-child(9),
        .loader-icons-bg i:nth-child(10),
        .loader-icons-bg i:nth-child(11) {
            animation: floatDown 10s infinite ease-in-out;
            top: -50px;
        }
        .loader-icons-bg i:nth-child(7) { left: 15%; animation-duration: 14s; animation-delay: 1s; font-size: 1.8rem; }
        .loader-icons-bg i:nth-child(8) { left: 40%; animation-duration: 16s; animation-delay: 3s; color: var(--info-color); }
        .loader-icons-bg i:nth-child(9) { left: 65%; animation-duration: 11s; animation-delay: 0s; }
        .loader-icons-bg i:nth-child(10) { left: 85%; animation-duration: 13s; animation-delay: 4s; font-size: 2.2rem; }
        .loader-icons-bg i:nth-child(11) { left: 5%; animation-duration: 15s; animation-delay: 6s; }


        /* --- Main Loader Content (Made Smaller) --- */
        .loader-main {
            text-align: center;
            color: var(--text-primary);
            position: relative;
            z-index: 10;
        }
        .loader-ring {
            width: 60px;   /* <- REDUCED from 150px */
            height: 60px;  /* <- REDUCED from 150px */
            border: 4px solid rgba(255, 255, 255, 0.2); /* Thinner border */
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 15px auto; /* Reduced margin */
        }
        .loader-text-container {
            animation: fadeIn 1s ease-in-out;
        }
        .loader-text-container h3 {
            font-size: 1.1rem; /* <- REDUCED from 1.3rem */
            font-weight: 600;
            margin: 0;
            letter-spacing: 1px;
            transition: opacity 0.5s ease-in-out;
        }
        .loader-text-container p {
            font-size: 0.8rem; /* <- REDUCED from 0.9rem */
            color: var(--text-secondary);
            margin-top: 5px;
        }
        /* =========== PREMIUM ANIMATED LOADER STYLES END =========== */

        /* --- Added for Simple Loader --- */
        #globalLoaderEl.simple {
            background: rgba(15, 23, 42, 0.85); /* Semi-transparent dark background */
            backdrop-filter: blur(5px);
            animation: none; /* Disable gradient animation */
        }
        #globalLoaderEl.simple .loader-icons-bg {
            display: none; /* Hide floating icons */
        }
        #globalLoaderEl.simple .loader-text-container p {
            display: none; /* Hide the sub-text for a cleaner look */
        }

        .placeholder-glow .placeholder { background-color: rgba(51, 65, 85, 0.5); animation: placeholder-glow 2s ease-in-out infinite; } .placeholder { background-color: rgba(51, 65, 85, 0.5); border-radius: 4px; } @keyframes placeholder-glow { 0% { background-color: rgba(51, 65, 85, 0.5); } 50% { background-color: rgba(51, 65, 85, 0.7); } 100% { background-color: rgba(51, 65, 85, 0.5); } } .interactive-list-item { cursor: pointer; } .referral-code { font-family: monospace; letter-spacing: 1px; user-select: all; } .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-bottom: 1px solid var(--border-color); } .header-left { display: flex; align-items: center; gap: 10px; } .header-logo { width: 40px; height: 40px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color); } .header-title { font-size: 0.9rem; font-weight: 500; line-height: 1.2; } .header-title span { font-size: 0.75rem; color: var(--text-secondary); display: block; } .header-back-button { background: none; border: none; color: var(--text-primary); font-size: 1.4rem; margin-right: 5px; display: none; padding: 5px; } .header-right { display: flex; align-items: center; gap: 15px; } .notification-icon { font-size: 1.3rem; color: var(--text-primary); position: relative; background: none; border: none; padding: 0; } .notification-badge { position: absolute; top: -3px; right: -5px; background-color: var(--danger-color); color: white; font-size: 0.6rem; width: 15px; height: 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .header-game-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-left: 10px; display: none; }

        /* --- NEW: Admin Status Indicator Styles --- */
        .header-game-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-status {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .admin-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            transition: background-color 0.3s ease;
        }
        .admin-status.online {
            color: var(--success-color);
            background-color: rgba(16, 185, 129, 0.1);
        }
        .admin-status.online .admin-status-dot {
            background-color: var(--success-color);
        }
        .admin-status.offline {
            color: var(--text-secondary);
            background-color: rgba(148, 163, 184, 0.1);
        }
        .admin-status.offline .admin-status-dot {
            background-color: var(--text-secondary);
        }
        /* --- END: New Styles --- */


        /* =========== FINAL WALLET CHIP STYLE (NO ICON) =========== */
        .wallet-chip {
            background: linear-gradient(145deg, #2a3a55, #1e293b);
            color: var(--text-primary);
            padding: 8px 16px; /* Adjusted padding for better spacing */
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem; /* Slightly larger font for visibility */
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.05);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            -webkit-tap-highlight-color: transparent;
            min-width: 90px; /* Ensures chip doesn't get too small */
            text-align: center;
        }

        .wallet-chip .currency-symbol {
            font-family: 'Arial', sans-serif;
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 700;
            margin-right: 4px;
        }

        .wallet-chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 75%;
            height: 100%;
            background: linear-gradient(100deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0) 100%);
            transform: skewX(-25deg);
            transition: left 0.7s ease-in-out;
        }

        .wallet-chip:hover::before {
            left: 125%;
        }

        .wallet-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }

        .wallet-chip:active {
            transform: translateY(0px) scale(0.98);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }
        /* ========================================================= */

        /* === FINAL PROFESSIONAL FOOTER NAVIGATION STYLES START === */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background-color: var(--bottom-nav-bg);
            display: flex;
            justify-content: space-around; /* This will evenly space the items */
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            border-top: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out; /* NEW: Added transition for smooth hiding */
        }
        .bottom-nav.hidden {
            transform: translateY(100%); /* NEW: Hides the footer by moving it down */
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-decoration: none;
            flex-basis: 0; /* Distribute space evenly */
            flex-grow: 1; /* Distribute space evenly */
            padding: 8px 0;
            transition: color 0.2s ease, transform 0.2s ease;
            border: none;
            background: none;
            cursor: pointer;
            height: 100%;
        }
        .nav-item i {
            font-size: 1.5rem; /* Consistent icon size */
            margin-bottom: 4px;
            line-height: 1;
        }
        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
            line-height: 1;
        }
        .nav-item:hover {
            color: var(--text-primary);
        }
        .nav-item.active {
            color: var(--accent-color);
        }
        /* === FINAL PROFESSIONAL FOOTER NAVIGATION STYLES END === */

        .swiper-container#promotionSliderEl { width: 100%; height: 200px; border-radius: 10px; margin-bottom: 25px; --swiper-pagination-color: var(--accent-color); --swiper-pagination-bullet-inactive-color: var(--text-secondary); --swiper-pagination-bullet-size: 8px; } .swiper-slide { background-color: var(--secondary-bg); border-radius: 10px; } .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; } .game-card { text-align: center; background-color: var(--card-bg); border-radius: 8px; overflow: hidden; padding: 0; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s ease; } .game-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); } .game-card img { width: 100%; height: 130px; object-fit: cover; display: block; } .game-card span { display: block; padding: 10px 5px; font-weight: 500; font-size: 0.9rem; color: var(--text-primary); } .tournament-tabs { display: flex; justify-content: space-around; background-color: var(--secondary-bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; } .tab-item { color: var(--text-secondary); background: none; border: none; padding: 8px 10px; font-size: 0.85rem; font-weight: 600; border-radius: 6px; flex-grow: 1; text-align: center; cursor: pointer; transition: background-color 0.2s, color 0.2s; } .tab-item.active { background-color: var(--primary-button-bg); color: var(--text-primary); } .tab-item i { margin-right: 5px; }
        .tournament-card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 15px; padding: 0; border: 1px solid var(--border-color); overflow: hidden; /* Added for banner */ }
        .tournament-banner-image { width: 100%; display: block; aspect-ratio: 16 / 9; object-fit: cover; background-color: var(--primary-bg); }
        .tournament-card-content { padding: 15px; }
        .tournament-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; } .tournament-card-tags span { background-color: var(--primary-bg); color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; padding: 3px 8px; border-radius: 4px; display: inline-block; border: 1px solid var(--border-color); margin-right: 4px; margin-bottom: 4px; } .tournament-card-timer { background-color: rgba(255, 255, 255, 0.1); color: var(--text-primary); font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 4px; } .tournament-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; color: var(--text-primary); } .tournament-card-title i { color: var(--accent-color); } .tournament-card-info { display: flex; justify-content: space-between; align-items: stretch; border-top: 1px dashed var(--border-color); border-bottom: 1px dashed var(--border-color); padding: 10px 0; margin: 10px 0; font-size: 0.8rem; } .info-item { text-align: center; flex: 1; padding: 0 5px; } .info-item span { display: block; color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px; } .info-item strong { color: var(--text-primary); font-weight: 600; font-size: 0.9rem; } .info-item .prize-icon { color: var(--accent-color); font-size: 1.2rem; } .tournament-card-spots { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 15px; } .tournament-card-spots span { font-weight: 600; } .progress { height: 6px; background-color: var(--primary-bg); border-radius: 3px; overflow: hidden; } .progress-bar { background-color: var(--warning-color); transition: width 0.3s ease; } .tournament-card-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; } .tournament-card-actions .btn-sm { padding: 8px 10px; font-size: 0.85rem; width: 100%; } .tournament-card-actions .btn-join { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; } .tournament-card-actions .btn-details { background-color: var(--secondary-bg); border: 1px solid var(--border-color); } .tournament-card-actions .btn-joined { background-color: var(--success-color); color: var(--text-primary); opacity: 0.8; } .tournament-card-actions .btn-disabled { background-color: var(--secondary-bg); opacity: 0.6; cursor: not-allowed; } .btn-idpass { background: var(--accent-gradient); color: var(--primary-bg); border: none; font-weight: 600; } .wallet-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color); } .wallet-card h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 25px; } .balance-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); } .balance-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; } .balance-item-label { font-size: 0.95rem; color: var(--text-secondary); } .balance-item-value { font-size: 1.1rem; font-weight: 600; }
        /* Fix: Style for Rupee symbol in wallet and transaction cards */
        .balance-item-value .currency-symbol, #recentTransactionsListEl .currency-symbol, #transactionHistoryBodyEl .currency-symbol {
            font-family: 'Arial', sans-serif;
            margin-right: 2px;
        }
        .balance-item-action { min-width: 100px; text-align: right; } .balance-item-action .btn-custom-link { font-size: 0.85rem; color: var(--accent-color); padding: 5px; } .balance-item-action .btn-withdraw { background-color: var(--primary-button-bg); color: #fff; font-size: 0.8rem; padding: 5px 12px; border-radius: 5px; border: none; } #recentTransactionsListEl .custom-card { background-color: var(--secondary-bg); }
        .profile-header-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; border: 1px solid var(--border-color); } .profile-avatar { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--accent-color); object-fit: cover; background-color: var(--primary-bg); }
        .profile-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; }
        .profile-name-container { display: flex; align-items: center; gap: 10px; }
        .edit-name-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; }
        .edit-name-btn:hover { color: var(--text-primary); }
        .profile-email { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px; word-break: break-all; } .profile-stats { display: flex; justify-content: space-around; width: 100%; border-top: 1px solid var(--border-color); padding-top: 15px; } .stat-item { text-align: center; flex: 1; } .stat-item strong { display: block; font-size: 1rem; font-weight: 600; } .stat-item span { font-size: 0.75rem; color: var(--text-secondary); }

        /* =========== NEW PREMIUM PROFILE STYLES START =========== */
        .profile-links .custom-card {
            padding: 0; /* Remove default padding since title is outside */
        }
        .profile-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 10px; /* Space between title and card */
            padding-left: 5px; /* Small indent to align with card content */
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profile-card-title i {
            font-size: 1.2rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profile-links .list-group {
            border: none; /* Remove border from list-group itself */
        }
        /* =========== NEW PREMIUM PROFILE STYLES END =========== */

        .profile-links .form-switch .form-check-input { background-color: var(--secondary-bg); border-color: var(--border-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e"); } .profile-links .form-switch .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e"); }

        /* =========== NEW LOGIN PAGE STYLES START =========== */
        body.login-active {
            padding-top: 0;
            padding-bottom: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), #2c1e4d;
            background-image: linear-gradient(160deg, #3f2272 0%, #1a0a36 100%);
        }
        body.login-active .app-header,
        body.login-active .bottom-nav {
            display: none !important;
        }
        #login-section {
            display: flex; /* Changed from none by JS */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        #login-section .login-logo {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            margin-bottom: 20px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.3);
        }
        #login-section .card {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            max-width: 570px; /* MODIFIED: Increased width */
            width: 120%;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        #login-section .card-title {
            color: #FFFFFF;
            font-weight: 600;
            font-size: 1.4rem;
            margin-bottom: 11px !important;
        }
        #login-section p.card-subtitle {
             color: var(--text-secondary);
             margin-bottom: 25px;
             font-size: 0.9rem;
        }
        #login-section .form-label { display: none; }
        #login-section .input-group-wrapper {
            position: relative;
            margin-bottom: 25px; /* MODIFIED: Increased margin to make space for absolute error message */
        }
        #login-section .input-group-wrapper i {
            position: absolute;
            left: 12px;
            top: 52%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
            pointer-events: none;
        }
        #login-section .form-control {
            background-color: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            height: 48px;
            padding-left: 45px;
            padding-right: 45px;
            font-size: 0.95rem;
            transition: background-color 0.2s, border-color 0.2s;
        }
        #login-section .form-control:focus {
            background-color: rgba(0, 0, 0, 0.3);
            border-color: #a855f7;
            box-shadow: 0 0 0 0.2rem rgba(168, 85, 247, 0.25);
        }
        #login-section .form-control::placeholder {
            color: var(--text-secondary);
        }
        .password-toggle-btn { /* MODIFIED: Made generic */
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 5;
        }
        #login-section .btn-login-main {
            background: var(--login-purple-gradient);
            color: white;
            font-weight: 600;
            padding: 11px;
            border-radius: 10px;
            border: none;
            transition: filter 0.2s;
        }
        #login-section .btn-login-main:hover {
            filter: brightness(1.2);
        }
        #login-section .btn-link {
            color: #c084fc;
            text-decoration: none;
            font-weight: 500;
        }
        #login-section .btn-link:hover {
            text-decoration: underline;
        }
        #login-section form {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        #login-section form.hidden-form {
            opacity: 0;
            transform: scale(0.98);
            position: absolute;
            pointer-events: none;
        }
        #loginStatusMessageEl, #signupStatusMessageEl, #resetStatusMessageEl {
            font-size: 0.9rem;
        }
        /* Style for the invalid input field */
        #login-section .form-control.is-invalid {
            border-color: var(--danger-color) !important;
        }
        /* MODIFIED: Remove warning icon from invalid password fields */
        #login-section input[type="password"].is-invalid {
            background-image: none;
        }
        /* Style for the feedback message */
        #login-section .invalid-feedback {
            display: none; /* Hidden by default */
            position: absolute; /* MODIFIED: Takes element out of document flow */
            bottom: -25px; /* MODIFIED: Position below the input field */
            left: 5px; /* MODIFIED: Align with input padding */
            width: 100%;
            font-size: .8em;
            color: var(--danger-color);
            text-align: left;
        }
        /* Show the feedback when the input is invalid */
        #login-section .form-control.is-invalid ~ .invalid-feedback {
            display: block;
        }
        /* =========== NEW LOGIN PAGE STYLES END =========== */

        /* Wrapper for password fields in modals */
        .modal .input-group-wrapper {
            position: relative;
        }
        .modal .form-control {
            padding-right: 45px;
        }

        .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .modal-header { border-bottom-color: var(--border-color); } .modal-footer { border-top-color: var(--border-color); } .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } .modal-body .phonepe-number { color: var(--warning-color); font-weight: bold; user-select: text; } #matchDetailsModalBodyEl pre { background-color: var(--primary-bg); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; } #policyModalBodyEl { line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; } #idPasswordModalEl .copy-btn { padding: 2px 6px; font-size: 0.8rem; margin-left: 8px; vertical-align: middle; } #policyModalBodyEl .copy-btn, #policyModalBodyEl #shareReferralBtn { padding: 4px 10px; font-size: 0.9rem; } #policyModalBodyEl #shareReferralBtn i, #policyModalBodyEl .copy-btn i { margin-right: 5px; } #securityWarning { background-color: var(--danger-color); color: white; padding: 10px 15px; text-align: center; font-size: 0.9rem; position: sticky; top: 60px; z-index: 999; border-bottom: 1px solid #a51d1d; } #securityWarning a { color: #ffdddd; text-decoration: underline; } #securityWarning button { background: none; border: 1px solid white; color: white; padding: 2px 8px; margin-left: 15px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; }
        /* Recharge Flow Styles */
        .recharge-card { background-color: var(--secondary-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .amount-input-group { position: relative; }
        .amount-input-group .form-control { font-size: 2rem; font-weight: 700; padding-left: 35px; border: none; background: transparent; box-shadow: none; border-bottom: 2px solid var(--border-color); border-radius: 0; text-align: center; }
        .amount-input-group .rupee-symbol { position: absolute; left: 0; top: 50%; transform: translateY(-50%); font-size: 1.8rem; font-weight: 700; color: var(--text-secondary); }
        .amount-presets { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .amount-preset-btn { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .amount-preset-btn:hover { background-color: var(--primary-button-bg); border-color: var(--primary-button-bg); }
        .payment-option-card { background-color: var(--primary-bg); border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: border-color 0.2s; margin-bottom: 15px; }
        .payment-option-card.selected { border-color: var(--accent-color); }
        .payment-option-card img { height: 25px; max-width: 80px; object-fit: contain; }
        .payment-option-card .form-check-input { float: right; margin-left: 10px; background-color: var(--secondary-bg); border-color: var(--border-color); box-shadow: none; }
        .payment-option-card .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        .payment-details-card { background-color: var(--primary-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color); }
        .payment-details-card .qr-code-container { width: 150px; height: 150px; padding: 8px; background: white; border-radius: 8px; }
        .payment-details-card .qr-code-container img { width: 100%; height: 100%; object-fit: contain; border-radius: 4px; }
        .vertical-stepper { position: relative; padding-left: 40px; margin-bottom: 20px; }
        .vertical-stepper::before { content: ''; position: absolute; left: 14px; top: 5px; bottom: 5px; width: 2px; background-color: var(--danger-color); }
        .vertical-stepper .step-icon { position: absolute; left: 0; top: 0; width: 30px; height: 30px; border-radius: 50%; background-color: var(--danger-color); color: white; display: flex; align-items: center; justify-content: center; }
        .step-content h5 { font-size: 1rem; font-weight: 600; margin-bottom: 5px; }
        .step-content p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px; }
        .step-content .form-control { background-color: var(--secondary-bg); }

        /* =========== NEW NOTIFICATION STYLES =========== */
        .notification-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }
        .notification-item-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .notification-item-content {
            flex-grow: 1;
        }
        .notification-item-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .notification-item-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .notification-item-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.8;
            margin-top: 8px;
        }
        .unread-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            border-radius: 50%;
            border: 2px solid var(--secondary-bg);
        }

        /* =========== NEW LEADERBOARD STYLES =========== */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--secondary-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }
        .leaderboard-item:first-child {
            border: 1px solid var(--accent-color);
            box-shadow: 0 0 8px rgba(250, 204, 21, 0.3);
        }
        .leaderboard-rank {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-secondary);
            width: 35px;
            text-align: center;
            flex-shrink: 0;
        }
        .leaderboard-item:first-child .leaderboard-rank {
            color: var(--accent-color);
            font-size: 1.3rem;
        }
        .leaderboard-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 10px;
            margin-right: 15px;
            border: 2px solid var(--border-color);
        }
        .leaderboard-user-info {
            flex-grow: 1;
            overflow: hidden; /* Prevent long names from breaking layout */
        }
        .leaderboard-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .leaderboard-earnings {
            font-weight: 600;
            font-size: 1rem;
            color: var(--accent-color);
            text-align: right;
            padding-left: 10px;
        }

        /* NEW CHAT STYLES */
        #chatMessagesEl {
            max-height: 50vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Newest messages at the bottom */
            padding: 10px;
        }
        .chat-bubble {
            padding: 8px 14px;
            border-radius: 18px;
            margin-top: 10px;
            max-width: 80%;
            word-wrap: break-word;
            cursor: pointer;
        }
        .chat-bubble .sender-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
        }
        .chat-bubble .msg-time {
             font-size: 0.7rem;
             opacity: 0.7;
             display: block;
             margin-top: 4px;
             text-align: right;
        }
        .my-message {
            background: var(--primary-button-bg);
            color: var(--text-primary);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .other-message {
            background: var(--secondary-bg);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        .other-message .sender-name {
            color: var(--accent-color);
        }

        /* Reply feature styles */
        .reply-quote-block {
            background-color: rgba(0,0,0,0.2);
            padding: 8px;
            border-left: 3px solid var(--accent-color);
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .reply-quote-block .sender-name {
            font-weight: 700;
            color: var(--accent-color);
            display: block;
            font-size: 0.8rem;
        }
        .reply-quote-block p {
            margin: 0;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #chatReplyContextEl {
            background-color: var(--primary-bg);
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
        }
        .reply-context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .reply-context-header strong {
            color: var(--accent-color);
        }
        #chatReplyContextEl p {
            font-size: 0.9rem;
            margin: 4px 0 0 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.9;
        }
        #cancelReplyBtn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            line-height: 1;
            padding: 0 5px;
        }

        /* --- NEW STYLES FOR WALLET ACTIONS --- */
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal-width columns */
            gap: 15px; /* Space between the buttons */
            margin-top: 25px; /* Space above the buttons */
        }

        /* Set Wallet Action button text/icon to black as requested */
        #addAmountWalletBtnEl, #withdrawBtnEl {
            color: #000000; /* Black color */
        }

        /* =========== NEW LIVE SUPPORT CHAT STYLES (MODIFIED) =========== */
        #liveChatMessagesEl {
            height: 65vh; /* Adjust height as needed */
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Newest messages at the bottom */
            padding: 15px;
            background-color: var(--primary-bg);
            border-radius: 8px 8px 0 0;
        }
        #live-support-section .custom-card {
            padding: 0; /* Remove padding from card to make chat UI full width */
        }
        .live-chat-footer {
            padding: 15px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
        }
        .chat-bubble-live {
            padding: 10px 16px;
            border-radius: 20px;
            margin-top: 10px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .chat-bubble-live .msg-time-live {
             font-size: 0.7rem;
             opacity: 0.7;
             display: block;
             margin-top: 5px;
             text-align: right;
        }
        .user-message {
            background: var(--primary-button-bg);
            color: var(--text-primary);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        /* MODIFIED AND NEW STYLES FOR ADMIN MESSAGE */
        .admin-message {
            background: var(--secondary-bg);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-start;
            padding: 10px; /* Adjust padding for the new layout */
        }
        .admin-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .admin-message-content {
             flex-grow: 1;
        }
        .admin-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 4px;
            display: block;
        }
        /* ====================================================== */

        /* =========== MODIFIED MY STATS MODAL STYLES =========== */
        #myStatsModal .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        #myStatsModal .modal-body {
            padding: 0;
        }
        .stats-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .stat-card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .stat-card.active {
            transform: translateY(-8px) scale(1.03);
            border-color: var(--accent-color);
            box-shadow: 0 8px 25px rgba(250, 204, 21, 0.2);
        }
        /* =========== UPDATED ICON STYLES =========== */
        .stat-card-icon {
            font-size: 3rem; /* Increased size for more impact */
            color: var(--accent-color);
            /* Removed width, height, background, border-radius, etc. */
        }
        .stat-card-info {
            flex-grow: 1;
        }
        .stat-card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
        }
        .stat-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        /* =========== PROMO CODE OVERLAY STYLES START (UPDATED) =========== */
        #promoCodeOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        #promoCodeOverlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .promo-code-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            width: 90%;
            max-width: 400px; /* MODIFIED: Increased width */
            padding: 30px 25px; /* MODIFIED: Increased vertical padding */
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }

        #promoCodeOverlay.visible .promo-code-card {
            transform: scale(1);
        }

        .promo-code-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            transition: color 0.2s;
        }
        .promo-code-close-btn:hover {
            color: var(--text-primary);
        }
        
        /* NEW: Title style */
        .promo-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 20px 0; /* MODIFIED: Margin for spacing */
            text-align: left;
        }

        .promo-code-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        /* REMOVED H3 from here */

        .gift-icon-wrapper {
            width: 70px;
            height: 70px;
            margin: 0 auto 15px auto;
            background: transparent; /* MODIFIED: Transparent background */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* REMOVED: border and box-shadow */
        }

        .gift-icon-wrapper i {
            font-size: 2.5rem;
            color: var(--accent-color);
        }

        .promo-code-body .form-group {
            margin-bottom: 20px;
        }

        .promo-code-body #promoCodeInput {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 12px;
        }

        .promo-code-status {
            font-size: 0.85rem;
            text-align: center;
            margin-top: 10px; /* Gap between input and error message */
            min-height: 20px; /* Prevent layout shift */
            font-weight: 500;
        }
        .promo-code-status.text-danger { color: var(--danger-color); }
        .promo-code-status.text-success { color: var(--success-color); }
        /* =========== PROMO CODE OVERLAY STYLES END =========== */
        
        /* ============ NEW LIVE STREAM STYLES START ============ */
        #youtube-player-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            background-color: #000;
            border-radius: 8px;
            margin-bottom: 15px; /* Space between video and chat */
        }
        #youtube-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        #liveStreamChatMessagesEl {
            height: 40vh; /* Adjust height as needed */
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Newest messages at the bottom */
            padding: 15px;
            background-color: var(--primary-bg); /* Added background for chat area */
        }
        #live-stream-section .custom-card {
            padding: 0; /* Remove padding as content will have its own */
        }
        /* ============= NEW LIVE STREAM STYLES END ============= */

    </style>
</head>

<body>

    <!-- Audio Elements for Background Music and Click Sound -->
<audio id="backgroundMusic" loop>
    <source src="audio/Free Fire _ Halloween Update _ Theme Song(MP3_160K).mp3" type="audio/mpeg">
</audio>
<audio id="clickSound">
    <source src="audio/click.mp3" type="audio/mpeg">
</audio>

     <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo" id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> WELCOME <span id="headerUserGreetingEl">Guest</span> </div>
            <!-- NEW: Modified Header Title for Dynamic Content and Status Indicator -->
            <div class="header-game-title" id="headerGameTitleEl">
                <span id="headerDynamicTitleTextEl">Game Title</span>
                <span id="adminStatusIndicatorEl" style="display: none;">
                    <span class="admin-status-dot"></span>
                    <span class="admin-status-text"></span>
                </span>
            </div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;">
                <span class="currency-symbol">NPR.</span><span id="headerChipBalanceEl">0</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- =========== NEW PREMIUM LOADER HTML START =========== -->
        <div id="globalLoaderEl">
            <!-- Background Floating Icons -->
            <div class="loader-icons-bg">
                <!-- Icons floating UP -->
                <i class="bi bi-trophy-fill"></i>
                <i class="bi bi-joystick"></i>
                <i class="bi bi-cash-coin"></i>
                <i class="bi bi-shield-shaded"></i>
                <i class="bi bi-controller"></i>
                <i class="bi bi-stars"></i>
                <!-- Icons floating DOWN -->
                <i class="bi bi-crosshair"></i>
                <i class="bi bi-gem"></i>
                <i class="bi bi-lightning-charge-fill"></i>
                <i class="bi bi-amd"></i>
                <i class="bi bi-fire"></i>
            </div>
            <!-- Main Loader Content -->
            <div class="loader-main">
                <div class="loader-ring"></div>
                <div class="loader-text-container">
                    <h3 id="loaderTextEl">Loading...</h3>
                    <p>Get Ready for the Ultimate Battle!</p>
                </div>
            </div>
        </div>
        <!-- =========== NEW PREMIUM LOADER HTML END =========== -->

        <!-- Login Section -->
        <section id="login-section" class="section">
             <div class="container d-flex flex-column align-items-center justify-content-center">
                <img src="https://i.ibb.co/LdPZtH5/ninja-logo.png" alt="App Logo" class="login-logo">
                <div class="card shadow-sm">
                    <div class="card-body p-4 p-md-5">

                        <!-- Login Form -->
                        <form id="emailLoginForm" novalidate>
                            <h2 class="card-title text-center">WELCOME</h2>
                            <p class="text-center card-subtitle">Let's us know what your email, and your password</p>

                            <div class="input-group-wrapper">
                               <i class="bi bi-envelope"></i>
                               <input type="email" class="form-control" id="loginEmailInputEl" placeholder="Enter Your Email" required>
                               <div class="invalid-feedback"></div>
                            </div>
                            <div class="input-group-wrapper">
                                <i class="bi bi-lock"></i>
                                <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required>
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                                <div class="invalid-feedback"></div>
                            </div>

                            <a href="#" id="forgotPasswordLinkEl" class="text-end small d-block mb-3" style="color: var(--text-secondary);">Forgot Password?</a>
                            <div id="loginStatusMessageEl" class="alert" style="display: none;"></div>

                            <div class="d-grid gap-2 mb-3">
                                <button type="button" class="btn btn-login-main" id="loginEmailBtnEl">Login</button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">Create a new account? SIGN UP</button>
                            </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" class="hidden-form" style="display: none;" novalidate>
                            <h2 class="card-title text-center">CREATE AN ACCOUNT</h2>
                            <p class="text-center card-subtitle">Let's us know what your name, email, and your password</p>

                            <div class="input-group-wrapper">
                                <i class="bi bi-person-check"></i>
                                <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter Refer Id (optional)">
                            </div>
                            <div class="input-group-wrapper">
                                <i class="bi bi-person"></i>
                                <input type="text" class="form-control" id="signupNameInputEl" placeholder="Enter Your Name" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="input-group-wrapper">
                                <i class="bi bi-envelope"></i>
                                <input type="email" class="form-control" id="signupEmailInputEl" placeholder="Enter Your Email" required>
                                <div class="invalid-feedback"></div>
                            </div>
                             <div class="input-group-wrapper">
                                <i class="bi bi-phone"></i>
                                <input type="tel" class="form-control" id="signupMobileInputEl" placeholder="Enter Your Mobile No" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="input-group-wrapper">
                                <i class="bi bi-lock"></i>
                                <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Create Password (min 6 chars)" required minlength="6">
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="input-group-wrapper">
                                <i class="bi bi-lock-fill"></i>
                                <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required>
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" class="btn btn-login-main" id="signupEmailBtnEl">Sign Up</button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">Already have an account? SIGN IN</button>
                            </div>
                        </form>

                        <!-- ============================================= -->
                        <!-- ====== NEW FORGOT PASSWORD FORM START ======= -->
                        <!-- ============================================= -->
                        <form id="forgotPasswordForm" class="hidden-form" style="display: none;" novalidate>
                            <h2 class="card-title text-center">Reset Password</h2>
                            <p class="text-center card-subtitle">Enter your email to receive a reset link.</p>

                            <div class="input-group-wrapper">
                               <i class="bi bi-envelope"></i>
                               <input type="email" class="form-control" id="resetEmailInputEl" placeholder="Enter Registered Email" required>
                               <div class="invalid-feedback"></div>
                            </div>

                            <div id="resetStatusMessageEl" class="alert mt-3" style="display: none;"></div>

                            <div class="d-grid gap-2 mb-3">
                                <button type="button" class="btn btn-login-main" id="sendResetLinkBtnEl">Send Reset Link</button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginFromResetBtnEl">Back to Login</button>
                            </div>
                        </form>
                        <!-- ============================================= -->
                        <!-- ====== NEW FORGOT PASSWORD FORM END ========= -->
                        <!-- ============================================= -->

                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- Promotion Slider -->
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>
                 </div>
                 <!-- DOTS ELEMENT REMOVED -->
            </div>

            <!-- Esport Games -->
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <!-- Placeholder Game Cards -->
                <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div> <div class="col-6"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
            </div>

            <!-- My Contests -->
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                 <!-- Placeholder Contest Card -->
                <div class="tournament-card placeholder-glow mb-3"> <div class="tournament-card-content"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow"> <div class="tournament-card placeholder-glow mb-3"> <div class="tournament-card-content"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div> </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>
                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label">Deposit Balance</span>
                    <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button> </div>
                </div>
                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label">Winning Cash</span>
                    <span class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action"></div>
                </div>
                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label">Bonus Cash</span>
                    <span class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action" style="min-width: 100px;"></div>
                </div>

                <!-- =========== UPDATED BUTTON CONTAINER =========== -->
                <div class="wallet-actions">
                    <button id="addAmountWalletBtnEl" class="btn btn-custom btn-custom-accent">
                        <i class="bi bi-plus-circle-fill"></i> Add Amount
                    </button>
                    <button id="withdrawBtnEl" class="btn btn-custom btn-custom-primary">
                        <i class="bi bi-cash-coin"></i> Withdraw
                    </button>
                </div>
                <!-- ========================================== -->

            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow"> <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div> <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p> </div>
        </section>

        <!-- Leaderboard Section (NEW) -->
        <section id="leaderboard-section" class="section">
            <h2 class="section-title">Top Players</h2>
            <div id="leaderboardListEl" class="placeholder-glow">
                 <!-- Placeholder Leaderboard Item -->
                <div class="leaderboard-item placeholder-glow mb-2">
                    <span class="placeholder col-1" style="height: 30px; width: 35px;"></span>
                    <span class="placeholder col-2 ms-2 me-3" style="height: 45px; width: 45px; border-radius: 50%;"></span>
                    <div style="flex-grow: 1;">
                         <span class="placeholder col-6 d-block" style="height: 20px;"></span>
                    </div>
                    <span class="placeholder col-3" style="height: 20px;"></span>
                </div>
                <div class="leaderboard-item placeholder-glow mb-2">
                    <span class="placeholder col-1" style="height: 30px; width: 35px;"></span>
                    <span class="placeholder col-2 ms-2 me-3" style="height: 45px; width: 45px; border-radius: 50%;"></span>
                    <div style="flex-grow: 1;">
                         <span class="placeholder col-5 d-block" style="height: 20px;"></span>
                    </div>
                    <span class="placeholder col-4" style="height: 20px;"></span>
                </div>
                 <div class="leaderboard-item placeholder-glow mb-2">
                    <span class="placeholder col-1" style="height: 30px; width: 35px;"></span>
                    <span class="placeholder col-2 ms-2 me-3" style="height: 45px; width: 45px; border-radius: 50%;"></span>
                    <div style="flex-grow: 1;">
                         <span class="placeholder col-6 d-block" style="height: 20px;"></span>
                    </div>
                    <span class="placeholder col-3" style="height: 20px;"></span>
                </div>
            </div>
             <p id="noLeaderboardMessageEl" class="text-secondary text-center mt-4" style="display: none;">Leaderboard is empty.</p>
        </section>

        <!-- ============ MODIFIED LIVE STREAM SECTION START ============ -->
        <section id="live-stream-section" class="section">
            <h2 class="section-title">Live Stream</h2>
        
            <!-- Combined Card for Video and Chat -->
            <div class="custom-card">
                <!-- Video Player Container -->
                <div id="youtube-player-container">
                    <!-- YouTube player will be embedded here by JavaScript -->
                    <p class="text-secondary text-center p-5">Loading Live Stream...</p>
                </div>
        
                <!-- Chat Messages Container -->
                <div id="liveStreamChatMessagesEl">
                    <!-- Chat messages will be loaded here -->
                    <div class="text-center p-5 text-secondary">
                        <div class="spinner-border spinner-border-sm"></div>
                        <div>Loading chat...</div>
                    </div>
                </div>
        
                <!-- Chat Input Footer -->
                <div class="live-chat-footer">
                    <form id="liveStreamChatForm" class="d-flex w-100 gap-2">
                        <input type="text" class="form-control" id="liveStreamChatMessageInput" placeholder="Type a message..." required autocomplete="off">
                        <button type="submit" class="btn btn-custom btn-custom-primary">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </section>
        <!-- ============= MODIFIED LIVE STREAM SECTION END ============= -->
        
        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow">
                <img src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl">
                <div class="profile-name-container mt-2">
                    <h3 class="profile-name" id="profileNameEl"><span class="placeholder col-6"></span></h3>
                    <button class="edit-name-btn" id="editNameBtnEl"><i class="bi bi-pencil-square"></i></button>
                </div>
                <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p>
                <div class="profile-stats w-100"> <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div> <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div> <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div> </div>
            </div>

            <!-- ======================================================= -->
            <!-- ================ MODIFIED SECTION START =============== -->
            <!-- ======================================================= -->
            <div class="profile-links">

                <!-- Account Links -->
                <h4 class="profile-card-title"><i class="bi bi-person-circle"></i> My Account</h4>
                <div class="custom-card mb-4">
                    <div class="list-group">
                        <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                            <span><i class="bi bi-bell-fill"></i> Notifications</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked>
                            </div>
                        </label>
                        <!-- =========== NEW "MY STATS" BUTTON ADDED HERE =========== -->
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="myStatsBtn">
                            <span><i class="bi bi-bar-chart-line-fill"></i> My Stats</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <!-- ========================================================== -->
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="matchHistoryBtn">
                            <span><i class="bi bi-clock-history"></i> Match History</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="transactionHistoryBtn">
                            <span><i class="bi bi-receipt-cutoff"></i> Transaction History</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="changePasswordBtn">
                            <span><i class="bi bi-key-fill"></i> Change Password</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <!-- =========== NEW PROMO CODE BUTTON =========== -->
                        <a href="#" id="promoCodeBtn" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                            <span><i class="bi bi-gift-fill"></i> Promo Code</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                         <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer">
                            <span><i class="bi bi-people-fill"></i> Refer & Earn</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Support & Policies Links -->
                <h4 class="profile-card-title"><i class="bi bi-shield-check"></i> Support & Policies</h4>
                <div class="custom-card mb-4">
                    <div class="list-group">
                        <!-- ============ NEW LIVE SUPPORT BUTTON ADDED HERE ============ -->
                        <a href="#" id="liveSupportBtn" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                            <span><i class="bi bi-chat-quote-fill"></i> Live Support</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <!-- ========================================================== -->
                        <a href="#" id="contactUsBtnEl" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                            <span><i class="bi bi-headset"></i> Contact Us</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="privacy">
                            <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms">
                            <span><i class="bi bi-file-text-fill"></i> Terms of Service</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund">
                            <span><i class="bi bi-arrow-repeat"></i> Refund Policy</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay">
                            <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Logout Card -->
                <div class="custom-card">
                    <div class="list-group">
                        <button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl">
                            <span><i class="bi bi-box-arrow-right"></i> Logout</span>
                            <span></span>
                        </button>
                    </div>
                </div>

            </div>
            <!-- ======================================================= -->
            <!-- ================= MODIFIED SECTION END ================ -->
            <!-- ======================================================= -->

        </section>

        <!-- ============ NEW LIVE SUPPORT SECTION ADDED HERE ============ -->
        <section id="live-support-section" class="section">
            <h2 class="section-title">Live Support</h2>
            <p class="text-secondary text-center mb-3">Chat with our support team in real-time.</p>
            <div class="custom-card">
                <div id="liveChatMessagesEl">
                    <!-- Chat messages will be loaded here by JavaScript -->
                    <div class="text-center p-5 text-secondary">
                        <div class="spinner-border spinner-border-sm"></div>
                        <div>Loading chat...</div>
                    </div>
                </div>
                <div class="live-chat-footer">
                    <form id="liveChatForm" class="d-flex w-100 gap-2">
                        <input type="text" class="form-control" id="liveChatMessageInput" placeholder="Type your message..." required autocomplete="off">
                        <button type="submit" class="btn btn-custom btn-custom-primary">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </section>
        <!-- ========================================================== -->

        <!-- RECHARGE SECTION -->
        <section id="recharge-section" class="section">
            <div id="recharge-step-1-amount">
                <div class="text-center mb-4">
                    <p class="text-secondary mb-1">Deposit Balance</p>
                    <h2 class="fw-bold">NPR.<span id="rechargeBalanceDisplay">0.00</span></h2>
                </div>
                <div class="recharge-card">
                    <label class="form-label text-center d-block">Amount</label>
                    <div class="amount-input-group">
                        <span class="rupee-symbol">NPR.</span>
                        <input type="number" class="form-control" id="rechargeAmountInput" placeholder="10 - 1000" min="10" max="1000">
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-secondary">Minimum: NPR.10</small>
                        <small class="text-secondary">Maximum: NPR.10000</small>
                    </div>
                    <div class="amount-presets">
                        <button class="amount-preset-btn" data-amount="20">NPR.20</button>
                        <button class="amount-preset-btn" data-amount="50">NPR.50</button>
                        <button class="amount-preset-btn" data-amount="100">NPR.100</button>
                        <button class="amount-preset-btn" data-amount="200">NPR.200</button>
                        <button class="amount-preset-btn" data-amount="500">NPR.500</button>
                        <button class="amount-preset-btn" data-amount="1000">NPR.1000</button>
                    </div>
                </div>
                <div id="rechargeStep1Status" class="alert" style="display: none;"></div>
                <div class="d-grid">
                    <button class="btn btn-custom btn-custom-primary btn-lg" id="goToStep2Btn">Recharge</button>
                </div>
            </div>
            <div id="recharge-step-2-method" style="display: none;">
                <div class="text-center mb-4">
                    <p class="text-secondary mb-1">Recharge Amount</p>
                    <h2 class="fw-bold">NPR.<span id="rechargeAmountConfirm">20</span></h2>
                </div>
                <h3 class="section-title">Select Payment Method</h3>
                <div id="paymentOptionsContainer">
                    <div class="payment-option-card">
                        <div class="d-flex align-items-center">
                            <img src="https://i.ibb.co/dNkvzjZ/e-Sewa-Company-Logo-FWu1-Yuc-LO0.jpg" alt="eSewa" class="me-3">
                            <span class="fw-bold">eSewa</span>
                        </div>
                        <input class="form-check-input" type="radio" name="paymentMethod" id="pay-eSewa" value="eSewa">
                    </div>
                    <div class="payment-option-card">
                        <div class="d-flex align-items-center">
                            <img src="https://i.ibb.co/0RPCnvWW/khalti-ime-logo.png" alt="Khalti" class="me-3">
                             <span class="fw-bold">Khalti</span>
                        </div>
                        <input class="form-check-input" type="radio" name="paymentMethod" id="pay-khalti" value="Khalti">
                    </div>
                    <div class="payment-option-card">
                        <div class="d-flex align-items-center">
                            <img src="https://i.ibb.co/0bjw8fG/images.webp" alt="IME" class="me-3">
                            <span class="fw-bold">IME</span>
                        </div>
                        <input class="form-check-input" type="radio" name="paymentMethod" id="pay-IME" value="IME">
                    </div>
                </div>
                <div id="rechargeStep2Status" class="alert" style="display: none;"></div>
                <div class="d-grid mt-4">
                    <button class="btn btn-custom btn-custom-primary btn-lg" id="goToStep3Btn">Process to Pay</button>
                </div>
            </div>
            <div id="recharge-step-3-payment" style="display: none;">
                <div class="text-center mb-4">
                    <p class="text-secondary mb-1">Recharge Amount</p>
                    <h2 class="fw-bold">NPR.<span id="rechargeFinalAmount">20</span></h2>
                </div>
                <div class="payment-details-card d-flex align-items-center justify-content-between mb-4">
                    <div>
                        <p class="text-secondary mb-1">Payment Mode : <strong class="text-primary" id="rechargePaymentMode">eSewa</strong></p>
                        <p class="mb-0">ID id : <strong class="text-accent" id="rechargeIDId">arnabsaikia609-1@okaxis</strong></p>
                    </div>
                    <div class="qr-code-container">
                        <img src="https://iili.io/FsMJsRV.md.png" alt="QR Code" id="rechargeQrCodeImg">
                    </div>
                </div>
                <div class="d-grid grid-cols-2 gap-2 mb-4" style="grid-template-columns: 1fr 1fr;">
                    <button class="btn btn-custom btn-custom-secondary" id="rechargeCopyAmtBtn">Copy Amt</button>
                    <button class="btn btn-custom btn-custom-secondary" id="rechargeCopyIDBtn">Copy QR</button>
                </div>
                <div class="vertical-stepper mb-4">
                    <div class="step-icon"><i class="bi bi-check"></i></div>
                    <div class="step-content">
                        <h5>Enter Payment Transaction Code</h5>
                        <p>After paying, enter the transaction ID below.</p>
                        <input type="text" class="form-control" id="rechargeUtrInput" placeholder="Enter Transaction Code here...">
                    </div>
                </div>
                <div class="vertical-stepper">
                    <div class="step-icon"><i class="bi bi-check"></i></div>
                    <div class="step-content">
                        <h5>Submit</h5>
                         <p>Our agent will verify your payment shortly.</p>
                    </div>
                </div>
                <div id="rechargeStep3Status" class="alert mt-4" style="display: none;"></div>
                <div class="d-grid gap-2 mt-4" style="grid-template-columns: 1fr 1fr;">
                    <button class="btn btn-custom btn-custom-secondary" id="rechargeCancelBtn">Cancel</button>
                    <button class="btn btn-custom btn-custom-primary" id="rechargeSubmitBtn">Submit</button>
                </div>
            </div>
        </section>

    </main>
    
    <!-- =========== NEW PROMO CODE OVERLAY START (UPDATED HTML) =========== -->
    <div id="promoCodeOverlay" style="display: none;">
        <div class="promo-code-card">
            <button id="closePromoCodeBtn" class="promo-code-close-btn">&times;</button>
            <h3 class="promo-card-title">Redeem Your Code</h3>
            <div class="promo-code-header">
                <div class="gift-icon-wrapper">
                    <i class="bi bi-gift-fill"></i>
                </div>
                <p id="promoCodeMessageEl" class="text-secondary">Enter a code to claim your reward.</p>
            </div>
            <div class="promo-code-body">
                <div class="form-group">
                    <input type="text" id="promoCodeInput" class="form-control" placeholder="Enter promo code">
                    <div id="promoCodeStatusMessage" class="promo-code-status"></div>
                </div>
                <button id="redeemPromoCodeBtn" class="btn btn-custom btn-custom-accent w-100">Redeem</button>
            </div>
        </div>
    </div>
    <!-- =========== NEW PROMO CODE OVERLAY END =========== -->

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div>
    <div class="modal fade" id="addAmountModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i> How to Add Amount?</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>To add amount, pay via QR/eSewa to:</p><p class="text-center text-warning"><strong>QR ID/Number:</strong> <span class="phonepe-number">[!!! YOUR QR ID/NUMBER HERE !!!]</span></p><p class="mt-3 small"><strong><i class="bi bi-exclamation-triangle-fill text-warning"></i> IMPORTANT:</strong> After payment, contact admin via [!!! ADMIN CONTACT INFO HERE !!!] with registered Email (<strong id="modalUserEmailEl">...</strong>) & payment screenshot. Amount added manually after verification.</p></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Got it</button></div></div></div></div>
    <div class="modal fade" id="withdrawModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">NPR.0.00</strong></p><div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min NPR.<span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount"></div><div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">id:98********@eSewa/@NTC?.</label><input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="Enter QR ID / Bank Details"></div><div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button></div></div></div></div>
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="matchDetailsModalBodyEl"></div></div></div></div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Room ID & Password</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-secondary">ID/Pass shown shortly before match start.</p><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Room ID:</p><h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button></div><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Password:</p><h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password"><i class="bi bi-clipboard"></i></button></div><p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.</p></div></div></div></div>
    <div class="modal fade" id="joinTournamentDetailsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Enter Your Details to Join</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <p>Entry Fee: <strong id="joinFeeDisplayEl" class="text-accent">NPR.0.00</strong></p>
        <form id="joinTournamentForm">
            <input type="hidden" id="joinTournamentIdInput">
            <input type="hidden" id="joinTournamentFeeInput">
            <input type="hidden" id="joinTournamentModeInput">
            <div class="mb-3">
                <label for="joinUsernameInput" class="form-label">Your Player Username</label>
                <input type="text" class="form-control" id="joinUsernameInput" placeholder="Enter your username" required>
            </div>
            <div class="mb-3">
                <label for="joinGameUidInput" class="form-label">Your Free Fire UID</label>
                <input type="text" class="form-control" id="joinGameUidInput" placeholder="Enter your in-game UID" required>
            </div>

            <!-- DUO Fields Container -->
            <div id="joinDuoFieldsContainer" style="display: none;">
                <hr>
                <h6 class="text-accent">Teammate Details</h6>
                <div class="mb-3">
                    <label for="joinTeammateUsernameInput" class="form-label">Teammate Username</label>
                    <input type="text" class="form-control" id="joinTeammateUsernameInput" placeholder="Enter teammate's username">
                </div>
                <div class="mb-3">
                    <label for="joinTeammateGameUidInput" class="form-label">Teammate Free Fire UID</label>
                    <input type="text" class="form-control" id="joinTeammateGameUidInput" placeholder="Enter teammate's in-game UID">
                </div>
            </div>

            <div id="joinTournamentStatusMessageEl" class="alert mt-3" style="display: none;"></div>
        </form>
    </div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-accent" id="confirmJoinBtn">Confirm & Join</button></div></div></div></div>
    <div class="modal fade" id="notificationsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Notifications</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="notificationsListEl"></div><p id="notificationsEmptyMsgEl" class="text-center text-secondary mt-4" style="display: none;">No notifications yet.</p></div></div></div></div>

    <!-- NEW MATCH HISTORY MODAL -->
    <div class="modal fade" id="matchHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-clock-history"></i> Match History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="matchHistoryBodyEl">
                    <!-- History cards will be loaded here by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- NEW TRANSACTION HISTORY MODAL -->
    <div class="modal fade" id="transactionHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt-cutoff"></i> Transaction History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transactionHistoryBodyEl">
                    <!-- History cards will be loaded here by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- NEW TOURNAMENT CHAT MODAL -->
    <div class="modal fade" id="tournamentChatModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tournamentChatModalTitle">Tournament Chat</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 d-flex flex-column">
                    <div id="chatMessagesEl" class="flex-grow-1">
                        <!-- Chat messages will be loaded here in reverse order -->
                    </div>
                    <div id="chatReplyContextEl" style="display: none;">
                        <div class="reply-context-header">
                            Replying to <strong id="replyToNameEl">...</strong>
                            <button type="button" id="cancelReplyBtn">&times;</button>
                        </div>
                        <p id="replyToMessageEl">...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <form id="chatForm" class="d-flex w-100 gap-2">
                        <input type="text" class="form-control" id="chatMessageInput" placeholder="Type a message..." required autocomplete="off">
                        <button type="submit" class="btn btn-custom btn-custom-primary">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW EDIT NAME MODAL -->
    <div class="modal fade" id="editNameModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Your Name</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editNameForm">
                        <div class="mb-3">
                            <label for="editNameInput" class="form-label">New Name</label>
                            <input type="text" class="form-control" id="editNameInput" required>
                        </div>
                        <div id="editNameStatusMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="saveNameChangeBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================== -->
    <!-- ==== NEW CHANGE PASSWORD MODAL === -->
    <!-- ================================== -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm" novalidate>
                        <div class="mb-3">
                            <label for="currentPasswordInput" class="form-label">Current Password</label>
                            <div class="input-group-wrapper">
                                <input type="password" class="form-control" id="currentPasswordInput" required>
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="newPasswordInput" class="form-label">New Password</label>
                            <div class="input-group-wrapper">
                                <input type="password" class="form-control" id="newPasswordInput" required>
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPasswordInput" class="form-label">Confirm New Password</label>
                             <div class="input-group-wrapper">
                                <input type="password" class="form-control" id="confirmNewPasswordInput" required>
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                            </div>
                        </div>
                        <div id="changePasswordStatusMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="savePasswordChangeBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========== UPDATED "MY STATS" MODAL =========== -->
    <div class="modal fade" id="myStatsModal" tabindex="-1" aria-labelledby="myStatsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content"> <!-- The background is now handled by CSS -->
                <div class="modal-header">
                    <h5 class="modal-title" id="myStatsModalLabel"><i class="bi bi-bar-chart-line-fill me-2"></i> My Stats</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="stats-container" id="statsCardContainer">
                        <!-- Stat cards -->
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-joystick"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Matches Played</p>
                                <h3 class="stat-card-value" id="statsMatchesPlayed">0</h3>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-trophy-fill"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Matches Won</p>
                                <h3 class="stat-card-value" id="statsMatchesWon">0</h3>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-crosshair"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Total Kills</p>
                                <h3 class="stat-card-value" id="statsTotalKills">0</h3>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-cash-coin"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Total Winnings</p>
                                <h3 class="stat-card-value" id="statsTotalWinnings">NPR.0.00</h3>
                            </div>
                        </div>
                         <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-person-plus-fill"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Referral Earnings</p>
                                <h3 class="stat-card-value" id="statsReferralEarnings">NPR.0.00</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ======================================================= -->


    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <!-- ============ NEW LIVE STREAM BUTTON ADDED ============ -->
        <button class="nav-item" data-section="live-stream-section"><i class="bi bi-youtube"></i><span>Live</span></button>
        <!-- ====================================================== -->
        <button class="nav-item" data-section="leaderboard-section"><i class="bi bi-trophy-fill"></i><span>Leaderboard</span></button>
        <button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp, limitToFirst, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        
        // NEW CODE: Added setPersistence and browserLocalPersistence to the import
        import { getAuth, EmailAuthProvider, reauthenticateWithCredential, updatePassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
 apiKey: "AIzaSyCGrSGtJDZ10Sp_WCd1gnVO5zkfZVJE5fA",
 authDomain: "win-98-e1681.firebaseapp.com",
 databaseURL: "https://win-98-e1681-default-rtdb.firebaseio.com",
 projectId: "win-98-e1681",
 storageBucket: "win-98-e1681.firebasestorage.app",
 messagingSenderId: "758395077705",
 appId: "1:758395077705:web:b9c065cd0904a3dd22eb98",
 measurementId: "G-JSQCHCBL3V"
};


        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);

            // =======================================================
            // ====== NEW CODE: Set Authentication Persistence START ======
            // =======================================================
            // This tells Firebase to save the user's login session to the device's local storage.
            // The user will now stay logged in even after closing the app or browser.
            setPersistence(auth, browserLocalPersistence)
              .then(() => {
                // This will run after persistence is set.
                // The onAuthStateChanged listener will now handle the persistent session correctly.
                console.log("Authentication persistence set to 'local'. User will stay logged in.");
              })
              .catch((error) => {
                // An error occurred.
                console.error("Error setting authentication persistence:", error);
              });
            // =======================================================
            // ====== NEW CODE: Set Authentication Persistence END ======
            // =======================================================

            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Could not connect. Check Firebase config & console. Error: ${error.message}</div>`;
        }

         const getElement = (id) => document.getElementById(id);
         const querySel = (selector) => document.querySelector(selector);
         const querySelAll = (selector) => document.querySelectorAll(selector);
         const elements = {
             // NEW: Added bottomNav for hiding/showing
             sections: querySelAll('.section'), bottomNav: querySel('.bottom-nav'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
             // NEW: Added elements for dynamic title and status
             headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerDynamicTitleText: getElement('headerDynamicTitleTextEl'), adminStatusIndicator: getElement('adminStatusIndicatorEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
             loginSection: getElement('login-section'),
             emailLoginForm: getElement('emailLoginForm'), loginEmailInput: getElement('loginEmailInputEl'), loginPasswordInput: getElement('loginPasswordInputEl'), loginEmailBtn: getElement('loginEmailBtnEl'), showSignupToggleBtn: getElement('showSignupToggleBtnEl'), loginStatusMessage: getElement('loginStatusMessageEl'), forgotPasswordLink: getElement('forgotPasswordLinkEl'),
             emailSignupForm: getElement('emailSignupForm'), signupNameInput: getElement('signupNameInputEl'), signupEmailInput: getElement('signupEmailInputEl'), signupMobileInputEl: getElement('signupMobileInputEl'), signupPasswordInput: getElement('signupPasswordInputEl'), signupConfirmPasswordInputEl: getElement('signupConfirmPasswordInputEl'), signupReferralCodeInput: getElement('signupReferralCodeInputEl'), signupEmailBtn: getElement('signupEmailBtnEl'), showLoginToggleBtn: getElement('showLoginToggleBtnEl'), signupStatusMessage: getElement('signupStatusMessageEl'),
             forgotPasswordForm: getElement('forgotPasswordForm'),
             resetEmailInput: getElement('resetEmailInputEl'),
             resetStatusMessage: getElement('resetStatusMessageEl'),
             sendResetLinkBtn: getElement('sendResetLinkBtnEl'),
             showLoginFromResetBtn: getElement('showLoginFromResetBtnEl'),
             homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
             tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
             walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
             profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
             leaderboardSection: getElement('leaderboard-section'), leaderboardListEl: getElement('leaderboardListEl'), noLeaderboardMessageEl: getElement('noLeaderboardMessageEl'),
             contactUsBtn: getElement('contactUsBtnEl'),
             rechargeSection: getElement('recharge-section'), rechargeStep1: getElement('recharge-step-1-amount'), rechargeStep2: getElement('recharge-step-2-method'), rechargeStep3: getElement('recharge-step-3-payment'), rechargeBalanceDisplay: getElement('rechargeBalanceDisplay'), rechargeAmountInput: getElement('rechargeAmountInput'), rechargePresetBtns: querySelAll('.amount-preset-btn'), rechargeStep1Status: getElement('rechargeStep1Status'), goToStep2Btn: getElement('goToStep2Btn'), rechargeAmountConfirm: getElement('rechargeAmountConfirm'), paymentOptionCards: querySelAll('.payment-option-card'), rechargeStep2Status: getElement('rechargeStep2Status'), goToStep3Btn: getElement('goToStep3Btn'), rechargeFinalAmount: getElement('rechargeFinalAmount'), rechargePaymentMode: getElement('rechargePaymentMode'), rechargeIDId: getElement('rechargeIDId'), rechargeQrCodeImg: getElement('rechargeQrCodeImg'), rechargeCopyAmtBtn: getElement('rechargeCopyAmtBtn'), rechargeCopyIDBtn: getElement('rechargeCopyIDBtn'), rechargeUtrInput: getElement('rechargeUtrInput'), rechargeStep3Status: getElement('rechargeStep3Status'), rechargeCancelBtn: getElement('rechargeCancelBtn'), rechargeSubmitBtn: getElement('rechargeSubmitBtn'),
             policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
             addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, modalUserEmail: getElement('modalUserEmailEl'),
             withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawMethodInput: getElement('withdrawMethodInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
             matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
             idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
             joinTournamentDetailsModalInstance: getElement('joinTournamentDetailsModal') ? new bootstrap.Modal(getElement('joinTournamentDetailsModal')) : null,
             joinFeeDisplayEl: getElement('joinFeeDisplayEl'),
             joinTournamentIdInput: getElement('joinTournamentIdInput'),
             joinTournamentFeeInput: getElement('joinTournamentFeeInput'),
             joinTournamentModeInput: getElement('joinTournamentModeInput'),
             joinUsernameInput: getElement('joinUsernameInput'),
             joinGameUidInput: getElement('joinGameUidInput'),
             joinDuoFieldsContainer: getElement('joinDuoFieldsContainer'),
             joinTeammateUsernameInput: getElement('joinTeammateUsernameInput'),
             joinTeammateGameUidInput: getElement('joinTeammateGameUidInput'),
             joinTournamentStatusMessage: getElement('joinTournamentStatusMessageEl'),
             confirmJoinBtn: getElement('confirmJoinBtn'),
             securityWarning: getElement('securityWarning'),
             notificationsModalInstance: getElement('notificationsModalEl') ? new bootstrap.Modal(getElement('notificationsModalEl')) : null,
             notificationsListEl: getElement('notificationsListEl'),
             notificationsEmptyMsgEl: getElement('notificationsEmptyMsgEl'),
             editNameBtnEl: getElement('editNameBtnEl'),
             editNameModalInstance: getElement('editNameModal') ? new bootstrap.Modal(getElement('editNameModal')) : null,
             editNameInput: getElement('editNameInput'),
             editNameStatusMessage: getElement('editNameStatusMessage'),
             saveNameChangeBtn: getElement('saveNameChangeBtn'),
             matchHistoryBtn: getElement('matchHistoryBtn'),
             matchHistoryModalInstance: getElement('matchHistoryModal') ? new bootstrap.Modal(getElement('matchHistoryModal')) : null,
             matchHistoryBodyEl: getElement('matchHistoryBodyEl'),
             transactionHistoryBtn: getElement('transactionHistoryBtn'),
             transactionHistoryModalInstance: getElement('transactionHistoryModal') ? new bootstrap.Modal(getElement('transactionHistoryModal')) : null,
             transactionHistoryBodyEl: getElement('transactionHistoryBodyEl'),
             tournamentChatModalInstance: getElement('tournamentChatModal') ? new bootstrap.Modal(getElement('tournamentChatModal')) : null,
             tournamentChatModalTitle: getElement('tournamentChatModalTitle'),
             chatMessagesEl: getElement('chatMessagesEl'),
             chatForm: getElement('chatForm'),
             chatMessageInput: getElement('chatMessageInput'),
             chatReplyContextEl: getElement('chatReplyContextEl'),
             replyToNameEl: getElement('replyToNameEl'),
             replyToMessageEl: getElement('replyToMessageEl'),
             cancelReplyBtn: getElement('cancelReplyBtn'),
             changePasswordBtn: getElement('changePasswordBtn'),
             changePasswordModalInstance: getElement('changePasswordModal') ? new bootstrap.Modal(getElement('changePasswordModal')) : null,
             savePasswordChangeBtn: getElement('savePasswordChangeBtn'),
             currentPasswordInput: getElement('currentPasswordInput'),
             newPasswordInput: getElement('newPasswordInput'),
             confirmNewPasswordInput: getElement('confirmNewPasswordInput'),
             changePasswordStatusMessage: getElement('changePasswordStatusMessage'),
             loaderTextEl: getElement('loaderTextEl'),
             liveSupportSection: getElement('live-support-section'),
             liveSupportBtn: getElement('liveSupportBtn'),
             liveChatMessagesEl: getElement('liveChatMessagesEl'),
             liveChatForm: getElement('liveChatForm'),
             liveChatMessageInput: getElement('liveChatMessageInput'),
             myStatsBtn: getElement('myStatsBtn'),
             myStatsModalInstance: getElement('myStatsModal') ? new bootstrap.Modal(getElement('myStatsModal')) : null,
             statsMatchesPlayed: getElement('statsMatchesPlayed'),
             statsMatchesWon: getElement('statsMatchesWon'),
             statsTotalKills: getElement('statsTotalKills'), 
             statsTotalWinnings: getElement('statsTotalWinnings'),
             statsReferralEarnings: getElement('statsReferralEarnings'),
             statsCardContainer: getElement('statsCardContainer'),
             // =========== NEW PROMO CODE ELEMENTS ===========
             promoCodeBtn: getElement('promoCodeBtn'),
             promoCodeOverlay: getElement('promoCodeOverlay'),
             closePromoCodeBtn: getElement('closePromoCodeBtn'),
             promoCodeInput: getElement('promoCodeInput'),
             promoCodeStatusMessage: getElement('promoCodeStatusMessage'),
             redeemPromoCodeBtn: getElement('redeemPromoCodeBtn'),
             promoCodeMessageEl: getElement('promoCodeMessageEl'),
             // =========== NEW LIVE STREAM ELEMENTS ===========
             liveStreamSection: getElement('live-stream-section'),
             youtubePlayerContainer: getElement('youtube-player-container'),
             liveStreamChatMessagesEl: getElement('liveStreamChatMessagesEl'),
             liveStreamChatForm: getElement('liveStreamChatForm'),
             liveStreamChatMessageInput: getElement('liveStreamChatMessageInput'),
         };

        let currentUser = null;
        let userProfile = {};
        let currentSectionId = 'login-section';
        let dbListeners = {};
        // NEW: Listener for admin status
        let adminStatusUnsubscribe = null;

        const protectedSections = ['home-section', 'wallet-section', 'profile-section', 'tournaments-section', 'recharge-section', 'leaderboard-section', 'live-support-section', 'live-stream-section'];

        let swiperInstance;
        let currentTournamentGameId = null;
        let appSettings = {};
        let tempReferralCode = null;
        let currentRechargeData = { amount: 0, paymentMethod: null, upiId: null };
        let currentChatListener = null;
        let currentLiveChatUnsubscribe = null;
        // NEW: Listener for Live Stream Chat
        let currentLiveStreamChatUnsubscribe = null;
        let currentReply = null; 
        let loaderTextInterval;
        let isInitialLoad = true;
        let outgoingLiveChatMessages = new Set();

        
        function startLoaderTextAnimation() {
            if (!elements.loaderTextEl) return;
            const texts = ["Loading Tournaments...", "Prepare for Battle!", "Win Real Cash Prizes!"];
            let currentIndex = 0;
            elements.loaderTextEl.style.opacity = 1;
            elements.loaderTextEl.textContent = texts[currentIndex];

            loaderTextInterval = setInterval(() => {
                elements.loaderTextEl.style.opacity = 0;
                setTimeout(() => {
                    currentIndex = (currentIndex + 1) % texts.length;
                    elements.loaderTextEl.textContent = texts[currentIndex];
                    elements.loaderTextEl.style.opacity = 1;
                }, 500); 
            }, 3000); 
        }

        
        function stopLoaderTextAnimation() {
            clearInterval(loaderTextInterval);
        }

        const showGlobalLoader = (show, forceSimple = false) => {
            if (elements.globalLoader) {
                if (show) {
                    if (!isInitialLoad || forceSimple) {
                        elements.globalLoader.classList.add('simple');
                        elements.loaderTextEl.textContent = "Loading..."; 
                    } else {
                        elements.globalLoader.classList.remove('simple');
                    }
                    elements.globalLoader.style.display = 'flex';
                    if (!elements.globalLoader.classList.contains('simple')) {
                        startLoaderTextAnimation();
                    }
                } else {
                    elements.globalLoader.style.display = 'none';
                    stopLoaderTextAnimation(); 
                    if (isInitialLoad) {
                        isInitialLoad = false;
                    }
                }
            }
        };

        function showStatusMessage(element, message, type = 'danger', autohide = true) { if (!element) return; element.innerHTML = message; element.className = `alert alert-${type}`; element.style.display = 'block'; element.setAttribute('role', 'alert'); if (autohide) { setTimeout(() => { if (element.innerHTML === message) element.style.display = 'none'; }, 5000); } }
        function clearStatusMessage(element) { if (!element) return; element.style.display = 'none'; element.innerHTML = ''; element.removeAttribute('role'); }
        function copyToClipboard(targetSelectorOrText, isText = false) { let textToCopy; if (isText) { textToCopy = targetSelectorOrText; } else { if (!targetSelectorOrText) { alert('Copy target not defined.'); return; } const targetElement = querySel(targetSelectorOrText); if (!targetElement) { alert('Element to copy from not found.'); return; } textToCopy = targetElement.textContent; } if (!textToCopy || textToCopy === 'N/A' || textToCopy.includes('placeholder')) { alert('Nothing to copy.'); return; } navigator.clipboard.writeText(textToCopy).then(() => alert('Copied!')).catch(err => { console.error('Failed to copy:', err); alert('Failed to copy.'); }); }

        function toggleButtonLoader(button, show, loadingText = '') {
            if (!button) return;
            if (show) {
                button.dataset.originalHtml = button.innerHTML;
                button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${loadingText}`;
                button.disabled = true;
            } else {
                if (button.dataset.originalHtml) {
                    button.innerHTML = button.dataset.originalHtml;
                    delete button.dataset.originalHtml;
                }
                button.disabled = false;
            }
        }

        function setFieldError(inputElement, message) {
            if (!inputElement) return;
            inputElement.classList.add('is-invalid');
            const errorEl = inputElement.parentElement.querySelector('.invalid-feedback');
            if (errorEl) errorEl.textContent = message;
        }

        function clearAllErrors(formElement) {
            if (!formElement) return;
            formElement.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            formElement.querySelectorAll('.invalid-feedback').forEach(el => {
                el.textContent = '';
            });
        }


        
        function formatLargeNumber(num) {
            if (num >= 100000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
            }
            return Math.floor(num);
        }


        function shareReferral(code) {
            if (!code || code === 'N/A') { alert('Referral code not available.'); return; }
            const appName = appSettings.appName || "Battle Raja";
            const signupBonus = appSettings.signupBonus || 10;
            const referralBonus = appSettings.referralBonus || 5;

            const shareText =
`Tournament App

App Name - ${appName}
Free Joining 
Sign up Bonus - NPR.${signupBonus}
Per Refer - NPR.${referralBonus} 
Fast Join Free

Use Code - ( ${code} ) Free NPR.${signupBonus} 

Download 
https://adixclash.wuaze.com/?i=1`;

            if (navigator.share) {
                 navigator.share({
                    title: `Join ${appName}!`,
                    text: shareText
                }).catch((error) => console.log('Error sharing', error));
            } else {
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
                window.open(whatsappUrl, '_blank');
            }
        }

        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        const formatDate = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);
            if (diffSeconds < 60) return 'Just now';
            const diffMinutes = Math.floor(diffSeconds / 60);
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
        };
        const formatFullDateTime = (timestamp) => {
if (!timestamp) return 'N/A';
const date = new Date(timestamp);
return date.toLocaleString('en-IN', {
year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
});
};
        function getTimeRemaining(startTime) { if (!startTime) return 'TBA'; const now = Date.now(); const diff = startTime - now; if (diff <= 0) return 'Starting Soon'; const days = Math.floor(diff / 86400000); const hours = Math.floor((diff % 86400000) / 3600000); const minutes = Math.floor((diff % 3600000) / 60000); let o = ''; if (days > 0) o += `${days}d `; if (hours > 0 || days > 0) o += `${hours}h `; o += `${minutes}m`; return o.trim() || 'Now'; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };

        // ======================================================
        // ============== NEW/MODIFIED FUNCTIONS START ==========
        // ======================================================

        /**
         * NEW: Function to stop the embedded YouTube video.
         * It works by clearing the content of the player's container.
         */
        function stopYouTubeVideo() {
            if (elements.youtubePlayerContainer) {
                // Replacing the innerHTML is the most reliable way to stop the video
                elements.youtubePlayerContainer.innerHTML = '<p class="text-secondary text-center p-5">Live Stream stopped.</p>';
                console.log("YouTube video stopped.");
            }
        }
        
        function showSection(sectionId, options = {}) {
            const { addToHistory = true } = options;

            // NEW: Stop video if navigating away from the live stream section
            if (currentSectionId === 'live-stream-section' && sectionId !== 'live-stream-section') {
                stopYouTubeVideo();
            }

            // NEW: Detach admin status listener when leaving the live support section
            if (currentSectionId === 'live-support-section' && sectionId !== 'live-support-section') {
                if (adminStatusUnsubscribe) {
                    adminStatusUnsubscribe();
                    adminStatusUnsubscribe = null;
                    console.log("Detached admin status listener.");
                }
            }

            if (!auth || !sectionId || !elements.sections) {
                console.error("Cannot show section", sectionId);
                return;
            }
            const targetSection = getElement(sectionId);
            if (!targetSection) {
                console.error(`Section element "${sectionId}" not found.`);
                const fallbackSection = currentUser ? 'home-section' : 'login-section';
                showSection(fallbackSection);
                return;
            }

            const isLoggedIn = !!currentUser;

            if (protectedSections.includes(sectionId) && !isLoggedIn) {
                showSection('login-section');
                return;
            }
            if (sectionId === 'login-section' && isLoggedIn) {
                showSection('home-section');
                return;
            }

            elements.sections.forEach(sec => {
                sec.style.display = 'none';
                sec.classList.remove('active');
            });

            targetSection.classList.add('active');
            targetSection.style.display = (sectionId === 'login-section') ? 'flex' : 'block';

            currentSectionId = sectionId;

            if (addToHistory && window.history) {
                const currentHash = window.location.hash.substring(1);
                if (currentHash !== sectionId) {
                    const state = { sectionId: sectionId };
                    const title = sectionId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    history.pushState(state, title, `#${sectionId}`);
                }
            }

            if (sectionId === 'login-section') {
                document.body.classList.add('login-active');
                toggleAuthForm('emailLoginForm');
            } else {
                document.body.classList.remove('login-active');
            }

            updateHeaderForSection(sectionId);
            elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));

            
            switch (sectionId) {
                case 'home-section': loadHomePageData(); break;
                case 'wallet-section': loadWalletData(); break;
                case 'profile-section': loadProfileData(); break;
                case 'leaderboard-section': loadLeaderboardData(); break;
                case 'live-stream-section': loadLiveStreamData(); break;
                case 'tournaments-section':
                    if (currentTournamentGameId) {
                        const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                        filterTournaments(currentTournamentGameId, activeTab);
                    } else {
                        elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>';
                    }
                    break;
            }
            window.scrollTo(0, 0);
        }

        async function logoutUser() {
            if (!auth) return;
            try {
                // NEW: Stop the video on logout
                stopYouTubeVideo();

                showGlobalLoader(true, true); 

                detachAllDbListeners();
                console.log("All DB listeners detached before signout.");

                await signOut(auth);

            } catch (e) {
                console.error("Sign Out Error:", e);
                alert(`Logout failed: ${e.message}`);
                
                if (currentUser) {
                    setupRealtimeListeners(currentUser.uid);
                }
                showGlobalLoader(false);
            }
        }
        
        // ======================================================
        // ============== NEW/MODIFIED FUNCTIONS END ============
        // ======================================================
        
        function updateHeaderForSection(sectionId) {
            const mainNavSections = ['home-section', 'wallet-section', 'leaderboard-section', 'profile-section', 'live-stream-section'];
            const isLiveSupport = sectionId === 'live-support-section';
            const showBackButton = !mainNavSections.includes(sectionId) && sectionId !== 'login-section';

            // NEW: Logic to hide/show elements for Live Support section
            if (elements.bottomNav) {
                elements.bottomNav.classList.toggle('hidden', isLiveSupport);
            }
            if(elements.headerWalletChip) {
                elements.headerWalletChip.style.display = isLiveSupport ? 'none' : (currentUser ? 'flex' : 'none');
            }
            if(elements.notificationBtn) {
                elements.notificationBtn.style.display = isLiveSupport ? 'none' : 'block';
            }
            if (elements.adminStatusIndicator) {
                elements.adminStatusIndicator.style.display = isLiveSupport ? 'flex' : 'none';
            }
             // END NEW

            if (elements.headerBackBtn) {
                elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
                if (showBackButton) {
                    elements.headerBackBtn.onclick = () => window.history.back();
                }
            }

            const defaultTitleVisible = !showBackButton;
            const isTournaments = sectionId === 'tournaments-section';
            const isRecharge = sectionId === 'recharge-section';
            
            if (elements.headerTitleContainer) {
                elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
            }

            if (elements.headerGameTitle) {
                elements.headerGameTitle.style.display = (isTournaments || isRecharge || isLiveSupport) ? 'flex' : 'none';
            }

            const dynamicTitleEl = elements.headerDynamicTitleText;
            if (isTournaments && currentTournamentGameId && dynamicTitleEl) {
                const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`;
                dynamicTitleEl.textContent = gameName;
            } else if (isRecharge && dynamicTitleEl) {
                dynamicTitleEl.textContent = 'Recharge';
            } else if (isLiveSupport && dynamicTitleEl) {
                // NEW: Set title from Firebase settings
                dynamicTitleEl.textContent = appSettings.liveSupportTitle || 'Live Support';
            } else if (defaultTitleVisible && elements.headerUserGreeting) {
                const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest';
                elements.headerUserGreeting.textContent = nameToShow;
            }
        }

        
        function handlePopState(event) {
            let sectionId;
            if (event.state && event.state.sectionId) {
                sectionId = event.state.sectionId;
            } else {
                
                const hash = window.location.hash.substring(1);
                sectionId = hash || (currentUser ? 'home-section' : 'login-section');
            }
            showSection(sectionId, { addToHistory: false });
        }

        
        window.addEventListener('popstate', handlePopState);

        

         function updateGlobalUI(isLoggedIn) { if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; } if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest'; if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0'; elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none'; }); }

         function populateUserInfo(user, profile) {
            if (!user || !profile) return;
            const displayName = profile.displayName || user.email?.split('@')[0] || 'User';
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
            const depositBalance = (profile.depositBalance || 0);
            const winningCash = (profile.winningCash || 0);
            const bonusCash = (profile.bonusCash || 0);

            const totalBalance = depositBalance + winningCash + bonusCash;
            const totalMatches = profile.totalMatches || 0;
            const wonMatches = profile.wonMatches || 0;
            const formatCurrency = (amount) => `${amount.toFixed(2)}`;

            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];

            if (elements.headerChipBalance) {
                elements.headerChipBalance.textContent = formatLargeNumber(totalBalance);
            }

            
            if (elements.walletTotalBalance) {
                elements.walletTotalBalance.innerHTML = `<span class="currency-symbol">NPR.</span>${formatCurrency(depositBalance)}`;
                removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow'));
            }
            if (elements.walletWinningCash) {
                elements.walletWinningCash.innerHTML = `<span class="currency-symbol">NPR.</span>${formatCurrency(winningCash)}`;
                removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow'));
            }
            if (elements.walletBonusCash) {
                elements.walletBonusCash.innerHTML = `<span class="currency-symbol">NPR.</span>${formatCurrency(bonusCash)}`;
                removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow'));
            }

            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = `NPR.${formatCurrency(winningCash)}`;
            if (elements.rechargeBalanceDisplay) elements.rechargeBalanceDisplay.textContent = formatCurrency(depositBalance);
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            if (elements.profileName) {
                elements.profileName.textContent = displayName;
                removePlaceholders(elements.profileName.closest('.placeholder-glow'));
            }
            if (elements.profileEmail) {
                elements.profileEmail.textContent = user.email || 'N/A';
                removePlaceholders(elements.profileEmail.closest('.placeholder-glow'));
            }
            if (elements.profileTotalMatches) {
                elements.profileTotalMatches.textContent = totalMatches;
                removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow'));
            }
            if (elements.profileWonMatches) {
                elements.profileWonMatches.textContent = wonMatches;
                removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow'));
            }
            if (elements.profileTotalEarnings) {
                elements.profileTotalEarnings.textContent = `NPR.${formatCurrency(profile.totalEarnings || 0)}`;
                removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow'));
            }
            if (elements.modalUserEmail) elements.modalUserEmail.textContent = user.email || 'N/A';
        }

        
        function toggleAuthForm(formIdToShow) {
            const forms = [elements.emailLoginForm, elements.emailSignupForm, elements.forgotPasswordForm];

            forms.forEach(form => {
                if (form) {
                    
                    const statusMessageEl = form.querySelector('.alert');
                    if (statusMessageEl) clearStatusMessage(statusMessageEl);
                    clearAllErrors(form);
                    form.reset();

                    if (form.id === formIdToShow) {
                        
                        form.style.display = 'block';
                        form.classList.remove('hidden-form');
                    } else {
                        
                        form.style.display = 'none';
                        form.classList.add('hidden-form');
                    }
                }
            });
        }


        async function signUpWithEmail() {
            if (!auth) return;

            const nameEl = elements.signupNameInput;
            const emailEl = elements.signupEmailInput;
            const mobileEl = elements.signupMobileInputEl;
            const passwordEl = elements.signupPasswordInput;
            const confirmPasswordEl = elements.signupConfirmPasswordInputEl;

            clearAllErrors(elements.emailSignupForm);
            clearStatusMessage(elements.signupStatusMessage);

            
            if (!nameEl.value.trim()) { return setFieldError(nameEl, 'Please enter your name.'); }
            if (!emailEl.value.trim()) { return setFieldError(emailEl, 'Please enter your email.'); }
            if (!mobileEl.value.trim()) { return setFieldError(mobileEl, 'Please enter your mobile number.'); }
            if (!passwordEl.value) { return setFieldError(passwordEl, 'Please create a password.'); }
            if (passwordEl.value.length < 6) { return setFieldError(passwordEl, 'please enter minimum 6 digit'); }
            if (!confirmPasswordEl.value) { return setFieldError(confirmPasswordEl, 'Please confirm your password.'); }
            if (passwordEl.value !== confirmPasswordEl.value) { return setFieldError(confirmPasswordEl, 'Passwords do not match.'); }

            toggleButtonLoader(elements.signupEmailBtn, true, 'Signing Up...');
            try {
                tempReferralCode = elements.signupReferralCodeInput.value.trim();
                const cred = await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passwordEl.value);
                await update(ref(db, `users/${cred.user.uid}`), { displayName: nameEl.value.trim(), mobileNumber: mobileEl.value.trim() });
            } catch (e) {
                console.error("Signup Error:", e);
                let m;
                switch (e.code) {
                    case 'auth/email-already-in-use':
                        m = 'This email is already registered. Please log in or use a different email.';
                        break;
                    case 'auth/weak-password':
                        m = 'Password is too weak. Please choose a stronger one with at least 6 characters.';
                        break;
                    case 'auth/invalid-email':
                        m = 'The email address is not valid. Please check the format.';
                        break;
                    case 'auth/network-request-failed':
                        m = 'Network error. Please check your internet connection.';
                        break;
                    default:
                        m = 'An unexpected error occurred. Please try again.';
                }
                showStatusMessage(elements.signupStatusMessage, m, 'danger');
            } finally {
                toggleButtonLoader(elements.signupEmailBtn, false);
            }
        }

        async function loginWithEmail() {
            if (!auth) return;

            const emailEl = elements.loginEmailInput;
            const passwordEl = elements.loginPasswordInput;

            clearAllErrors(elements.emailLoginForm);
            clearStatusMessage(elements.loginStatusMessage);

            
            if (!emailEl.value.trim()) { return setFieldError(emailEl, 'Please enter your email.'); }
            if (!passwordEl.value) { return setFieldError(passwordEl, 'Please enter your password.'); }

            toggleButtonLoader(elements.loginEmailBtn, true, 'Logging In...');
            try {
                await signInWithEmailAndPassword(auth, emailEl.value.trim(), passwordEl.value);
            } catch (e) {
                console.error("Login Error:", e);
                let m;
                switch (e.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        m = 'Invalid email or password. Please check your credentials and try again.';
                        break;
                    case 'auth/too-many-requests':
                        m = 'Access temporarily disabled due to many failed login attempts. Please reset your password or try again later.';
                        break;
                    case 'auth/network-request-failed':
                        m = 'Network error. Please check your internet connection and try again.';
                        break;
                    case 'auth/user-disabled':
                        m = 'This account has been disabled. Please contact support.';
                        break;
                    default:
                        m = 'An unexpected error occurred. Please try again.';
                }
                showStatusMessage(elements.loginStatusMessage, m, 'danger');
            } finally {
                toggleButtonLoader(elements.loginEmailBtn, false);
            }
        }

        
        async function sendResetLink(emailInputEl, statusMessageEl) {
            if (!auth) return;
            const email = emailInputEl.value.trim();

            if (!email) {
                showStatusMessage(statusMessageEl, 'Please enter your email to receive a reset link.', 'warning');
                return;
            }

            toggleButtonLoader(elements.sendResetLinkBtn, true, 'Sending...');
            clearStatusMessage(statusMessageEl);

            try {
                await sendPasswordResetEmail(auth, email);
                showStatusMessage(statusMessageEl, 'Password reset email sent! Check your inbox and spam folder.', 'success', false);
            } catch (e) {
                console.error("Reset Pass Error:", e);
                let message;
                switch (e.code) {
                    case 'auth/user-not-found':
                    case 'auth/invalid-email':
                        message = 'No account was found with this email address.';
                        break;
                    case 'auth/network-request-failed':
                        message = 'Network error. Please check your internet connection.';
                        break;
                    default:
                        message = 'An unexpected error occurred. Please try again.';
                }
                showStatusMessage(statusMessageEl, message, 'danger');
            } finally {
                toggleButtonLoader(elements.sendResetLinkBtn, false);
            }
        }

        /**
         * Preloads an array of image URLs.
         * @param {string[]} urls - The array of image URLs to preload.
         * @returns {Promise<void>} A promise that resolves when all images have been loaded or failed.
         */
        async function preloadImages(urls) {
            if (!Array.isArray(urls) || urls.length === 0) {
                return Promise.resolve();
            }
            // Filter out any null/undefined URLs and get unique values to prevent redundant downloads
            const uniqueUrls = [...new Set(urls.filter(url => url))];
            console.log(`Preloading ${uniqueUrls.length} unique images.`);

            const promises = uniqueUrls.map(url => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = url;
                    // Resolve the promise on both load and error to ensure Promise.all doesn't reject
                    // if a single image fails, which would block the UI.
                    img.onload = resolve;
                    img.onerror = () => {
                        console.warn(`Failed to preload image: ${url}`);
                        resolve(); // Resolve anyway
                    };
                });
            });
            return Promise.all(promises);
        }

        async function handleAuthStateChange(user) {
            if (!auth || !db) { showGlobalLoader(false); return; }
            detachAllDbListeners();
            currentUser = user;
            const referralCodeFromSignup = tempReferralCode;
            tempReferralCode = null;

            if (user) {
                try {
                    const userRef = ref(db, 'users/' + user.uid);
                    const snapshot = await get(userRef);

                    if (snapshot.exists()) {
                        userProfile = snapshot.val();
                        await update(userRef, { lastLogin: serverTimestamp() });
                    } else {
                        console.log("New user detected, creating profile...");
                        const signupBonus = appSettings.signupBonus ?? 10;
                        const displayName = user.displayName || elements.signupNameInput.value.trim() || user.email?.split('@')[0] || 'User';
                        const mobileNumber = elements.signupMobileInputEl.value.trim() || null;

                        const newUserProfile = {
                            uid: user.uid, displayName: displayName, email: user.email || null, mobileNumber: mobileNumber, photoURL: user.photoURL || null,
                            depositBalance: 0, winningCash: 0, bonusCash: signupBonus,
                            totalMatches: 0, wonMatches: 0, totalKills: 0, totalEarnings: 0, referralEarnings: 0,
                            createdAt: serverTimestamp(), referralCode: generateReferralCode(), joinedTournaments: {},
                            isAdmin: false, lastCheckedNotifications: Date.now(), lastLogin: serverTimestamp()
                        };

                        if (referralCodeFromSignup) {
                             const q = query(ref(db, 'users'), orderByChild('referralCode'), equalTo(referralCodeFromSignup));
                             const referrerSnapshot = await get(q);
                             if (referrerSnapshot.exists()) {
                                 const referrerData = referrerSnapshot.val();
                                 const referrerId = Object.keys(referrerData)[0];
                                 const referrerProfile = referrerData[referrerId];
                                 const pendingReferralRef = push(ref(db, 'pendingReferrals'));
                                 await set(pendingReferralRef, {
                                     referrerUid: referrerId, referrerEmail: referrerProfile.email,
                                     referredUid: user.uid, referredEmail: user.email,
                                     status: 'pending', timestamp: serverTimestamp()
                                 });
                                 newUserProfile.referredBy = referrerId;
                             }
                        }

                        await set(userRef, newUserProfile);
                        userProfile = newUserProfile;
                        if (signupBonus > 0) {
                           await recordTransaction(user.uid, 'signup_bonus', signupBonus, `Welcome Bonus`);
                        }
                    }

                    // --- NEW PRELOADING LOGIC ---
                    const [promotionsSnapshot, gamesSnapshot] = await Promise.all([
                        get(ref(db, 'promotions')),
                        get(ref(db, 'games'))
                    ]);

                    const imageUrlsToPreload = [];
                    if (userProfile.photoURL) imageUrlsToPreload.push(userProfile.photoURL);
                    if (appSettings.logoUrl) imageUrlsToPreload.push(appSettings.logoUrl);
                    if (appSettings.loginLogoUrl) imageUrlsToPreload.push(appSettings.loginLogoUrl);

                    const promotions = promotionsSnapshot.val() || {};
                    Object.values(promotions).forEach(p => {
                        if (p.imageUrl) imageUrlsToPreload.push(p.imageUrl);
                    });

                    const games = gamesSnapshot.val() || {};
                    Object.values(games).forEach(g => {
                        if (g.imageUrl) imageUrlsToPreload.push(g.imageUrl);
                    });

                    await preloadImages(imageUrlsToPreload);
                    // --- END OF PRELOADING LOGIC ---

                    // Now, update the UI and show the content.
                    populateUserInfo(user, userProfile);
                    setupRealtimeListeners(user.uid);
                    updateGlobalUI(true);
                    loadAndDisplayNotifications();

                    let targetSection = 'home-section';
                    const initialHash = window.location.hash.substring(1);
                    if (initialHash && getElement(initialHash) && protectedSections.includes(initialHash)) {
                        targetSection = initialHash;
                    }

                    history.replaceState({ sectionId: targetSection }, '', `#${targetSection}`);
                    showSection(targetSection, { addToHistory: false });

                } catch (error) {
                    console.error("Profile handling or preloading error:", error);
                    alert("Error loading your profile. Logging out. " + error.message);
                    try { await logoutUser(); } catch (logoutErr) {}
                } finally {
                    // Hide the loader only after everything is ready.
                    showGlobalLoader(false);
                }
            } else {
                // Logged-out user logic
                console.log("Auth State: Logged Out");
                currentUser = null;
                userProfile = {};
                updateGlobalUI(false);
                history.replaceState({ sectionId: 'login-section' }, '', '#login-section');
                showSection('login-section', { addToHistory: false });
                showGlobalLoader(false); // Hide loader for login screen
            }
        }

        function applyTheme(theme) {
            if (!theme) return;
            const root = document.documentElement;
            for (const [key, value] of Object.entries(theme)) {
                if (value) {
                    root.style.setProperty(`--${key}`, value);
                }
            }
        }

        async function loadAppSettings() {
            console.log("Loading App Settings...");
            try {
                const settingsRef = ref(db, 'settings');
                const snapshot = await get(settingsRef);
                if (snapshot.exists()) {
                    appSettings = snapshot.val() || {};
                    
                    if (appSettings.logoUrl) {
                        elements.appLogo.src = appSettings.logoUrl;
                    }
                    
                    const loginLogo = document.querySelector('.login-logo');
                    if (loginLogo) {
                        if (appSettings.loginLogoUrl) {
                            
                            loginLogo.src = appSettings.loginLogoUrl;
                        } else if (appSettings.logoUrl) {
                            
                            loginLogo.src = appSettings.logoUrl;
                        }
                    }
                    
                    if (appSettings.minWithdraw && elements.minWithdrawAmount) {
                        elements.minWithdrawAmount.textContent = appSettings.minWithdraw;
                    }
                    if (appSettings.theme) {
                        console.log("Applying theme from settings...");
                        applyTheme(appSettings.theme);
                    }
                    // NEW: Load promo code message
                    if (elements.promoCodeMessageEl && appSettings.promoCodeMessage) {
                        elements.promoCodeMessageEl.textContent = appSettings.promoCodeMessage;
                    }
                } else {
                    console.warn("App Settings not found in database! Using defaults.");
                    appSettings = {
                        minWithdraw: 50,
                        signupBonus: 10,
                        referralBonus: 5,
                        supportContact: '9389660753',
                        upiDetails: 'aashif4412@ibl',
                        qrCodeUrl: 'https://iili.io/FsMJsRV.md.png',
                        promoCodeMessage: 'Enter a code to claim your reward.' // Default message
                    };
                    if (elements.promoCodeMessageEl) {
                        elements.promoCodeMessageEl.textContent = appSettings.promoCodeMessage;
                    }
                }
            } catch (e) {
                console.error("Settings load failed", e);
                appSettings = {
                    minWithdraw: 50,
                    signupBonus: 10,
                    referralBonus: 5,
                    supportContact: '9389660753',
                    upiDetails: 'aashif4412@ibl',
                    qrCodeUrl: 'https://iili.io/FsMJsRV.md.png',
                    promoCodeMessage: 'Enter a code to claim your reward.' // Default message
                };
                if (elements.promoCodeMessageEl) {
                    elements.promoCodeMessageEl.textContent = appSettings.promoCodeMessage;
                }
            }
        }

        function loadHomePageData() { console.log("Loading Home Page Data..."); if (!currentUser) { if(elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = ''; if(elements.gamesList) elements.gamesList.innerHTML = ''; if(elements.myContestsList) elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view contests.</p>'; return; } loadPromotions(); loadGames(); loadMyContests(); }
        async function loadPromotions() {
            console.log("Loading Promotions...");
            if (!elements.promotionSlider) return;
            const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
            if (!sliderWrapper) return;
            sliderWrapper.classList.add('placeholder-glow');
            sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>`;
            const promoRef = ref(db, 'promotions');
            try {
                const snapshot = await get(promoRef);
                const promotions = snapshot.val() || {};
                const activePromotions = Object.values(promotions).filter(p => p.imageUrl);
                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '';
                if (activePromotions.length > 0) {
                    elements.promotionSlider.style.display = 'block';
                    activePromotions.forEach(promo => {
                        const slide = document.createElement('div');
                        slide.className = 'swiper-slide';
                        slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>` : `<img src="${promo.imageUrl}" alt="Promo">`;
                        sliderWrapper.appendChild(slide);
                    });
                    if (swiperInstance) swiperInstance.destroy(true, true);

                    swiperInstance = new Swiper(elements.promotionSlider, {
                        loop: activePromotions.length > 1,
                        autoplay: {
                            delay: 3500,
                            disableOnInteraction: false
                        },
                        pagination: {
                            el: '.swiper-pagination',
                            clickable: true
                        },
                        slidesPerView: 1,
                        spaceBetween: 14
                    });

                } else {
                    elements.promotionSlider.style.display = 'none';
                }
            } catch (e) {
                console.error("Promo load failed:", e);
                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>';
                elements.promotionSlider.style.display = 'block';
            }
        }
        async function loadGames() { console.log("Loading Games..."); if (!elements.gamesList) return; elements.gamesList.classList.add('placeholder-glow'); elements.gamesList.innerHTML = `<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>`; const gamesRef = ref(db, 'games'); try { const snapshot = await get(gamesRef); const games = snapshot.val() || {}; const activeGames = Object.entries(games).filter(([, game]) => game.imageUrl && game.name).sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0)); removePlaceholders(elements.gamesList); elements.gamesList.innerHTML = ''; if (activeGames.length > 0) { if (!appSettings.games) appSettings.games = {}; activeGames.forEach(([gameId, game]) => { appSettings.games[gameId] = { name: game.name }; const col = document.createElement('div'); col.className = 'col-6'; col.innerHTML = `<div class="game-card custom-card" data-game-id="${gameId}" data-game-name="${game.name}"><img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`; col.querySelector('.game-card').addEventListener('click', () => { currentTournamentGameId = gameId; loadTournamentsForGame(gameId, game.name); }); elements.gamesList.appendChild(col); }); } else { elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>'; } } catch (e) { console.error("Games load failed:", e); removePlaceholders(elements.gamesList); elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>'; } }
        function loadTournamentsForGame(gameId, gameName) { if (!elements.tournamentsSection) return; currentTournamentGameId = gameId; elements.tournamentTabs.forEach(t => t.classList.remove('active')); querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active'); showSection('tournaments-section'); filterTournaments(gameId, 'upcoming'); }
        async function filterTournaments(gameId, status) { if (!elements.tournamentsListContainer) return; elements.tournamentsListContainer.innerHTML = ''; elements.tournamentsListContainer.classList.add('placeholder-glow'); elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><div class="tournament-card-content"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div></div>`; elements.noTournamentsMessage.style.display = 'none'; try { const tQuery = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId)); const s = await get(tQuery); const allT = s.val() || {}; const fT = Object.entries(allT).filter(([, t]) => t.status === status).sort(([, tA], [, tB]) => (tA.startTime || 0) - (tB.startTime || 0)); removePlaceholders(elements.tournamentsListContainer); elements.tournamentsListContainer.innerHTML = ''; if (fT.length > 0) { fT.forEach(([tId, t]) => { const card = createTournamentCardElement(tId, t); elements.tournamentsListContainer.appendChild(card); }); } else { elements.noTournamentsMessage.style.display = 'block'; elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`; } } catch (e) { console.error(`Tournaments filter failed (${status}):`, e); removePlaceholders(elements.tournamentsListContainer); elements.tournamentsListContainer.innerHTML = '<p class="text-danger tc mt-4">Could not load tournaments.</p>'; elements.noTournamentsMessage.style.display = 'none'; } }
        function createTournamentCardElement(tId, t) {
            const card = document.createElement('div');
            card.className = 'tournament-card';
            card.dataset.tournamentId = tId;

            const bannerUrl = t.bannerUrl || 'https://via.placeholder.com/400x225/1E293B/94A3B8?text=16:9+Banner';
            const eFee = t.entryFee || 0; const pkPrize = t.perKillPrize || 0; const pPool = t.prizePool || 0; const sTime = t.startTime ? new Date(t.startTime) : null;             const sTimeLoc = sTime ? sTime.toLocaleString('en-IN', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : 'TBA'; const regP = t.registeredPlayers || {}; const regC = Object.keys(regP).length; const maxP = t.maxPlayers || 0; const spotsL = maxP > 0 ? Math.max(0, maxP - regC) : Infinity; const isF = maxP > 0 && spotsL <= 0; const isJ = currentUser && userProfile?.joinedTournaments?.[tId]; const canJ = !isJ && !isF && t.status === 'upcoming';
            let timerTxt = t.status?.toUpperCase() || 'N/A';
            if (t.status === 'upcoming' && sTime) timerTxt = getTimeRemaining(t.startTime);
            else if (t.status === 'ongoing') timerTxt = 'LIVE';
            else if (t.status === 'completed' || t.status === 'result') timerTxt = 'ENDED';

            let spotsTxt = 'Unlimited Spots';
            let progP = 0;
            if (maxP > 0) {
                spotsTxt = `<span class="${spotsL <= 5 ? 'text-danger' : 'text-accent'}">${spotsL}</span> Spots Left (${regC}/${maxP})`;
                progP = Math.min(100, (regC / maxP) * 100);
            }

            let joinBtnHtml = '';
            let idPassBtn = '';
            let chatBtnHtml = '';

            if (isJ) {
                joinBtnHtml = `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`;
                if (t.status === 'ongoing' || (t.status === 'upcoming' && t.showIdPass && sTime && Date.now() > sTime.getTime() - 900000)) {
                    idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
                }
                if(t.status === 'ongoing' || t.status === 'upcoming') {
                    chatBtnHtml = `<button class="btn btn-custom btn-custom-secondary btn-sm btn-chat" data-tournament-id="${tId}" data-tournament-name="${t.name || 'Tournament'}"><i class="bi bi-chat-dots-fill"></i> Chat</button>`
                }
            } else if (canJ) {
                const mode = t.mode || 'Solo';
                const finalFee = (mode === 'Duo' ? eFee * 2 : eFee);
                joinBtnHtml = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee="${eFee}" data-mode="${mode}">NPR.${eFee} Join <i class="bi bi-arrow-right-short"></i></button>`;
            } else {
                let disR = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'Full' : 'Closed');
                joinBtnHtml = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disR || 'N/A'}</button>`;
            }

            card.innerHTML = `
                <img src="${bannerUrl}" alt="Tournament Banner" class="tournament-banner-image">
                <div class="tournament-card-content">
                    <div class="tournament-card-header">
                        <div class="tournament-card-tags">${t.mode ? `<span>${t.mode}</span>` : ''}${t.map ? `<span>${t.map}</span>` : ''}${t.tags ? (Array.isArray(t.tags) ? t.tags.map(tag => `<span>${tag}</span>`).join('') : Object.values(t.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}</div>
                        <div class="tournament-card-timer">${timerTxt}</div>
                    </div>
                    <h3 class="tournament-card-title">${t.icon ? `<i class="${t.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'} ${t.name || 'Tournament'}</h3>
                    <p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p>
                    <div class="tournament-card-info">
                        <div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> NPR.${pPool}</strong></div>
                        <div class="info-item"><span>Per Kill</span><strong>NPR.${pkPrize}</strong></div>
                        <div class="info-item"><span>Entry Fee</span><strong class="${eFee > 0 ? 'text-info' : ''}">${eFee > 0 ? `NPR.${eFee}` : 'Free'}</strong></div>
                    </div>
                    <div class="tournament-card-spots">${spotsTxt}${maxP > 0 ? `<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}</div>
                    <div class="tournament-card-actions">
                        <button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tId}">Details</button>
                        ${chatBtnHtml}
                        ${joinBtnHtml}
                    </div>
                    ${idPassBtn}
                </div>`;

            const jBtn = card.querySelector('.btn-join'); if (jBtn) jBtn.addEventListener('click', handleJoinTournamentClick);
            const dBtn = card.querySelector('.btn-details'); if (dBtn) dBtn.addEventListener('click', handleMatchDetailsClick);
            const ipBtn = card.querySelector('.btn-idpass'); if (ipBtn) ipBtn.addEventListener('click', handleIdPasswordClick);
            const cBtn = card.querySelector('.btn-chat'); if (cBtn) cBtn.addEventListener('click', (e) => openTournamentChat(e.currentTarget.dataset.tournamentId, e.currentTarget.dataset.tournamentName));
            return card;
        }

        async function loadMyContests() { if (!currentUser || !elements.myContestsList) { if(elements.myContestsList) removePlaceholders(elements.myContestsList); if(elements.myContestsList) elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; } const joinedIds = Object.keys(userProfile.joinedTournaments || {}); elements.myContestsList.classList.add('placeholder-glow'); elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><div class="tournament-card-content"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div></div>`; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'none'; if (joinedIds.length === 0) { removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; } try { const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`))); const snapshots = await Promise.all(contestPromises); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; const contestCards = []; snapshots.forEach((snapshot, index) => { if (snapshot.exists()) { const t = snapshot.val(); if (t.status === 'upcoming' || t.status === 'ongoing') { const tId = joinedIds[index]; contestCards.push({ startTime: t.startTime || 0, card: createTournamentCardElement(tId, t) }); } } }); contestCards.sort((a, b) => a.startTime - b.startTime); if (contestCards.length > 0) { contestCards.forEach(item => elements.myContestsList.appendChild(item.card)); } else if (elements.noContestsMessage) { elements.noContestsMessage.style.display = 'block'; elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests."; } } catch (e) { console.error("My contests load failed:", e); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>'; } }
        function loadWalletData() { if (!currentUser) return; loadRecentTransactions(); }
        function loadProfileData() { if (!currentUser) return; if (userProfile?.displayName) { removePlaceholders(elements.profileName?.closest('.placeholder-glow')); removePlaceholders(elements.profileEmail?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileWonMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalEarnings?.closest('.placeholder-glow')); } }
        
        async function loadLeaderboardData() {
            if (!currentUser) return;
            const listEl = elements.leaderboardListEl;
            const emptyMsgEl = elements.noLeaderboardMessageEl;
            listEl.innerHTML = `
                <div class="leaderboard-item placeholder-glow mb-2">
                    <span class="placeholder col-1" style="height: 30px; width: 35px;"></span>
                    <span class="placeholder col-2 ms-2 me-3" style="height: 45px; width: 45px; border-radius: 50%;"></span>
                    <div style="flex-grow: 1;"><span class="placeholder col-6 d-block" style="height: 20px;"></span></div>
                    <span class="placeholder col-3" style="height: 20px;"></span>
                </div>`.repeat(5);
            emptyMsgEl.style.display = 'none';

            try {
                const leaderboardQuery = query(ref(db, 'users'), orderByChild('leaderboardRank'), limitToFirst(100));
                const snapshot = await get(leaderboardQuery);

                removePlaceholders(listEl);
                listEl.innerHTML = '';

                if (!snapshot.exists()) {
                    emptyMsgEl.style.display = 'block';
                    return;
                }

                const leaderboardData = [];
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user && user.leaderboardRank) {
                        leaderboardData.push(user);
                    }
                });

                leaderboardData.sort((a, b) => a.leaderboardRank - b.leaderboardRank);

                if (leaderboardData.length === 0) {
                    emptyMsgEl.style.display = 'block';
                    return;
                }

                leaderboardData.forEach(user => {
                    const displayName = user.displayName || user.email?.split('@')[0] || 'User';
                    const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=1E293B&color=E2E8F0&bold=true&size=45`;
                    const displayEarnings = user.leaderboardDisplayEarnings || 0;

                    const itemEl = document.createElement('div');
                    itemEl.className = 'leaderboard-item';
                    itemEl.innerHTML = `
                        <div class="leaderboard-rank">#${user.leaderboardRank}</div>
                        <img src="${photoURL}" alt="${displayName}" class="leaderboard-avatar">
                        <div class="leaderboard-user-info">
                            <div class="leaderboard-name">${displayName}</div>
                        </div>
                        <div class="leaderboard-earnings">NPR.${displayEarnings.toLocaleString('en-IN')}</div>
                    `;
                    listEl.appendChild(itemEl);
                });

            } catch(error) {
                 console.error("Error loading leaderboard:", error);
                 listEl.innerHTML = `<p class="text-center text-danger">Could not load leaderboard. ${error.message}</p>`;
            }
        }
        // ============ NEW LIVE STREAM FUNCTIONS START ============
        async function loadLiveStreamData() {
            if (!currentUser) return;
            // Detach any previous chat listener
            if (currentLiveStreamChatUnsubscribe) {
                currentLiveStreamChatUnsubscribe();
                currentLiveStreamChatUnsubscribe = null;
            }

            const playerContainer = elements.youtubePlayerContainer;
            playerContainer.innerHTML = '<p class="text-secondary text-center p-5">Loading Live Stream...</p>';
            elements.liveStreamChatMessagesEl.innerHTML = '<div class="text-center p-5 text-secondary"><div class="spinner-border spinner-border-sm"></div><div>Loading chat...</div></div>';

            try {
                const streamSettingsRef = ref(db, 'settings/liveStream');
                const snapshot = await get(streamSettingsRef);
                const streamData = snapshot.val();

                if (streamData && streamData.youtubeVideoId) {
                    const videoId = streamData.youtubeVideoId;
                    playerContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&playsinline=1&controls=0&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                } else {
                    playerContainer.innerHTML = '<p class="text-secondary text-center p-5">Live stream is currently offline.</p>';
                }
                
                // Setup chat
                const chatRef = query(ref(db, `liveStreamChat`), limitToLast(50));
                currentLiveStreamChatUnsubscribe = onChildAdded(chatRef, (snapshot) => {
                    if (elements.liveStreamChatMessagesEl.querySelector('.spinner-border')) {
                        elements.liveStreamChatMessagesEl.innerHTML = '';
                    }
                    const msg = snapshot.val();
                    if(msg) {
                        appendChatMessage(msg, true, elements.liveStreamChatMessagesEl); // Re-use appendChatMessage
                    }
                });

            } catch(error) {
                console.error("Failed to load live stream data:", error);
                playerContainer.innerHTML = `<p class="text-danger text-center p-5">Error loading stream. ${error.message}</p>`;
                elements.liveStreamChatMessagesEl.innerHTML = '<p class="text-danger text-center">Could not load chat.</p>';
            }
        }

        async function handleLiveStreamChatSubmit(event) {
            event.preventDefault();
            const messageText = elements.liveStreamChatMessageInput.value.trim();
            if (!messageText || !currentUser) return;

            const messageData = {
                uid: currentUser.uid,
                displayName: userProfile.displayName,
                message: messageText,
                timestamp: serverTimestamp()
            };

            try {
                await push(ref(db, `liveStreamChat`), messageData);
                elements.liveStreamChatMessageInput.value = '';
            } catch(error) {
                console.error("Error sending live stream chat message:", error);
                alert(`Could not send message: ${error.message}`);
            }
        }
        // ============== NEW LIVE STREAM FUNCTIONS END ==============
        
        async function recordTransaction(userId, type, amount, description, details = {}) { if (!userId) return; const transactionRef = ref(db, `transactions/${userId}`); const newTransaction = { type, amount, description, timestamp: serverTimestamp(), ...details }; try { await push(transactionRef, newTransaction); console.log(`Transaction recorded: ${type}, Amount: ${amount}`); } catch (e) { console.error("Transaction record failed:", e); } }
        async function loadRecentTransactions() { if (!currentUser || !elements.recentTransactionsList) return; const limit = 5; elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow'); for (let i = 0; i < 3; i++) elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>`; if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading transactions...'; } try { const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit)); const s = await get(transRef); const transactions = s.val() || {}; const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = ''; if (sortedT.length > 0) { if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; sortedT.forEach(t => { const item = document.createElement('div'); item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center'; const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}<span class="currency-symbol">NPR.</span>${Math.abs(t.amount || 0).toFixed(2)}`; const time = t.timestamp ? new Date(t.timestamp).toLocaleString('en-IN', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : 'N/A'; item.innerHTML = `<div><div class="small fw-bold">${t.description || t.type || 'Txn'}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">${amt}</div>`; elements.recentTransactionsList.appendChild(item); }); } else if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'No recent transactions.'; } } catch (e) { console.error("Transactions load failed:", e); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>'; if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; } }
        function handleWithdrawClick() { if (!currentUser || !elements.withdrawModalInstance) return; const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; elements.minWithdrawAmount.textContent = minW; elements.withdrawModalBalance.textContent = `NPR.${wc.toFixed(2)}`; elements.withdrawAmountInput.value = ''; elements.withdrawAmountInput.min = minW; elements.withdrawMethodInput.value = userProfile.upiId || ''; clearStatusMessage(elements.withdrawStatusMessage); elements.withdrawModalInstance.show(); }
        async function submitWithdrawRequestHandler() { if (!currentUser || !elements.withdrawModalInstance) return; const amt = parseFloat(elements.withdrawAmountInput.value); const mtd = elements.withdrawMethodInput.value.trim(); const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; clearStatusMessage(elements.withdrawStatusMessage); if (isNaN(amt) || amt <= 0) { showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount.', 'warning'); return; } if (amt < minW) { showStatusMessage(elements.withdrawStatusMessage, `Min withdraw NPR.${minW}.`, 'warning'); return; } if (amt > wc) { showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance.', 'warning'); return; } if (!mtd) { showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning'); return; } elements.submitWithdrawRequestBtn.disabled = true; elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...'; let transactionCommitted = false; try { const uRef = ref(db, `users/${currentUser.uid}`); const txResult = await runTransaction(uRef, (prof) => { if (prof) { if ((prof.winningCash || 0) >= amt) { prof.winningCash = (prof.winningCash || 0) - amt; return prof; } else { throw new Error("Insufficient winning balance (Tx)."); } } else { throw new Error("Profile missing (Tx)."); } }); if (!txResult.committed) { throw new Error("Failed to update balance. Please try again."); } transactionCommitted = true; const wrRef = ref(db, 'withdrawals'); const newReq = { userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amt, methodDetails: { methodName: mtd.includes('@') ? 'QR' : 'Bank/Other', accountInfo: mtd }, status: 'pending', requestTimestamp: serverTimestamp(), userEmail: currentUser.email || 'N/A' }; const newWithdrawalRef = await push(wrRef, newReq); await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, { withdrawalId: newWithdrawalRef.key }); showStatusMessage(elements.withdrawStatusMessage, 'Request submitted successfully!', 'success', false); setTimeout(() => { if (elements.withdrawModalInstance) elements.withdrawModalInstance.hide(); }, 2500); if (currentSectionId === 'wallet-section') loadRecentTransactions(); } catch (e) { console.error("Withdraw error:", e); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger'); if (transactionCommitted) { console.warn("Attempting to refund winning cash..."); const uRef = ref(db, `users/${currentUser.uid}`); try { await runTransaction(uRef, (prof) => { if (prof) { prof.winningCash = (prof.winningCash || 0) + amt; } return prof; }); await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal Request`); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. Amount refunded.`, 'danger'); } catch (refundError) { console.error("CRITICAL: FAILED TO REFUND WINNING CASH!", refundError); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. CRITICAL: Failed to refund amount! Contact support.`, 'danger', false); } } } finally { elements.submitWithdrawRequestBtn.disabled = false; elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request'; } }
        async function handleMatchDetailsClick(event) { if (!elements.matchDetailsModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return; elements.matchDetailsModalTitle.textContent = 'Loading...'; elements.matchDetailsModalBody.innerHTML = '<div class="tc p-5"><div class="spinner-border spinner-border-sm"></div></div>'; elements.matchDetailsModalInstance.show(); try { const tRef = ref(db, `tournaments/${tId}`); const s = await get(tRef); if (s.exists()) { const t = s.val(); const gName = appSettings.games?.[t.gameId]?.name || t.gameId || 'N/A'; const sTimeLoc = t.startTime ? new Date(t.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short'}) : 'TBA'; let pDistHTML = ''; if (t.prizeDistribution) { let fmtDist = ''; if (typeof t.prizeDistribution === 'object') { fmtDist = Object.entries(t.prizeDistribution).map(([rank, prize]) => `Rank ${rank}: NPR.${prize}`).join('\n'); } else { fmtDist = String(t.prizeDistribution).replace(/\\n/g, '\n'); } pDistHTML = `<h5>Prize Distribution:</h5><pre>${fmtDist}</pre>`; } const desc = t.description || 'Standard rules apply.'; const fmtDesc = desc.replace(/\n/g, '<br>'); elements.matchDetailsModalTitle.textContent = t.name || 'Match Details'; elements.matchDetailsModalBody.innerHTML = `<p><strong>Game:</strong> ${gName}</p><p><strong>Mode:</strong> ${t.mode || 'N/A'}</p><p><strong>Map:</strong> ${t.map || 'N/A'}</p><p><strong>Starts:</strong> ${sTimeLoc}</p><hr><p><strong>Entry:</strong> ${t.entryFee > 0 ? `NPR.${t.entryFee}` : 'Free'}</p><p><strong>Prize:</strong> NPR.${t.prizePool || 0}</p><p><strong>Per Kill:</strong> NPR.${t.perKillPrize || 0}</p><p><strong>Max Players:</strong> ${t.maxPlayers > 0 ? t.maxPlayers : 'Unlimited'}</p><hr><h5>Rules:</h5><div style="white-space: pre-wrap; line-height: 1.6;">${fmtDesc}</div>${pDistHTML}`; } else elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>'; } catch (e) { console.error("Details load failed:", e); elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>'; } }
        async function handleIdPasswordClick(event) { if (!elements.idPasswordModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return; if (!currentUser || !userProfile?.joinedTournaments?.[tId]) { alert("Join the tournament first or refresh the page."); return; } elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>'; elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>'; elements.idPasswordModalInstance.show(); try { const tournamentRef = ref(db, `tournaments/${tId}`); const s = await get(tournamentRef); removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow')); removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow')); if (s.exists()) { const tournamentData = s.val(); if (tournamentData.showIdPass) { elements.roomIdDisplay.textContent = tournamentData.roomId || 'Not updated yet'; elements.roomPasswordDisplay.textContent = tournamentData.roomPassword || 'Not updated yet'; } else { elements.roomIdDisplay.textContent = 'Hidden by Admin'; elements.roomPasswordDisplay.textContent = 'Hidden by Admin'; } } else { elements.roomIdDisplay.textContent = 'Not Found'; elements.roomPasswordDisplay.textContent = 'Not Found'; } } catch (e) { console.error("ID/Pass fetch error:", e); removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow')); removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow')); elements.roomIdDisplay.textContent = 'Error'; elements.roomPasswordDisplay.textContent = 'Error'; alert("Error loading ID/Password."); } }
        async function handlePolicyClick(event) { if (!elements.policyModalInstance) return; event.preventDefault(); const target = event.currentTarget; const policyType = target.dataset.policy; if (!policyType) return; let title = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>'; elements.policyModalBody.innerHTML = modalBodyContent; switch (policyType) { case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; break; case 'terms': title = 'Terms and Conditions'; modalBodyContent = appSettings.policyTerms || 'Content not available.'; break; case 'refund': title = 'Refund and Cancellation'; modalBodyContent = appSettings.policyRefund || 'Content not available.'; break; case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; break; case 'refer': title = 'Refer & Earn'; if (!currentUser) { alert("Login to view referral."); return; } const refCode = userProfile.referralCode || 'N/A'; const referralBonus = appSettings.referralBonus || 5; modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">Get NPR.${referralBonus} when your friend joins using your code, and they get a signup bonus!</p></div>`; break; default: title = 'Info'; modalBodyContent = '<p>Content unavailable.</p>'; } elements.policyModalTitle.textContent = title; if (typeof modalBodyContent === 'string' && policyType !== 'refer') { elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>'); } else { elements.policyModalBody.innerHTML = modalBodyContent; } elements.policyModalInstance.show(); }
        function setupRealtimeListeners(uid) { if (!uid || !db || !currentUser) return; detachAllDbListeners(); const uRef = ref(db, `users/${uid}`); const listFunc = onValue(uRef, (s) => { if (currentUser && currentUser.uid === uid) { if (s.exists()) { const oldProfile = userProfile; userProfile = s.val(); populateUserInfo(currentUser, userProfile); if (currentSectionId === 'home-section') loadMyContests(); if (currentSectionId === 'wallet-section') loadRecentTransactions(); if (oldProfile.lastCheckedNotifications !== userProfile.lastCheckedNotifications) { loadAndDisplayNotifications(); } } else { alert("Account data missing or deleted. Logging out."); logoutUser(); } } else { off(uRef, 'value', listFunc); } }, (e) => { console.error("Listener error (user profile):", e); }); dbListeners['userProfile'] = { path: `users/${uid}`, func: listFunc }; }
        function detachAllDbListeners() { for (const k in dbListeners) { try { const { path, func } = dbListeners[k]; if (path && func) { off(ref(db, path), 'value', func); } } catch (e) { console.error(`Detach error ${k}:`, e); } } dbListeners = {}; }
        async function checkSecurityRules() { try { if (!currentUser) { } else if (elements.securityWarning) { elements.securityWarning.style.display = 'none'; } } catch (error) { if (elements.securityWarning) elements.securityWarning.style.display = 'none'; } }
        function startRechargeFlow() {
            
            if (!currentUser) { alert("Please login to add amount."); showSection('login-section'); return; }
            currentRechargeData = { amount: 0, paymentMethod: null, upiId: null };
            elements.rechargeAmountInput.value = '';
            elements.rechargeUtrInput.value = '';
            clearStatusMessage(elements.rechargeStep1Status);
            clearStatusMessage(elements.rechargeStep2Status);
            clearStatusMessage(elements.rechargeStep3Status);
            elements.rechargeBalanceDisplay.textContent = (userProfile.depositBalance || 0).toFixed(2);
            showSection('recharge-section'); 
            goToRechargeStep(1);
        }
        function goToRechargeStep(step) { elements.rechargeStep1.style.display = (step === 1) ? 'block' : 'none'; elements.rechargeStep2.style.display = (step === 2) ? 'block' : 'none'; elements.rechargeStep3.style.display = (step === 3) ? 'block' : 'none'; }
        function handleGoToStep2() { const amount = parseFloat(elements.rechargeAmountInput.value); if (isNaN(amount) || amount < 10 || amount > 1000) { showStatusMessage(elements.rechargeStep1Status, "Please enter an amount between NPR.10 and NPR.1000.", 'warning'); return; } clearStatusMessage(elements.rechargeStep1Status); currentRechargeData.amount = amount; elements.rechargeAmountConfirm.textContent = amount.toFixed(2); goToRechargeStep(2); }

        function handleGoToStep3() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                showStatusMessage(elements.rechargeStep2Status, "Please select a payment method.", "warning");
                return;
            }
            clearStatusMessage(elements.rechargeStep2Status);
            currentRechargeData.paymentMethod = selectedMethod.value;

            
            currentRechargeData.upiId = appSettings.upiDetails || 'upi-id-not-found@pay';
            const qrCodeUrl = appSettings.qrCodeUrl || 'https://via.placeholder.com/150/FFFFFF/000000?text=QR+Not+Available';

            
            elements.rechargeFinalAmount.textContent = currentRechargeData.amount.toFixed(2);
            elements.rechargePaymentMode.textContent = currentRechargeData.paymentMethod;
            elements.rechargeIDId.textContent = currentRechargeData.upiId;
            if (elements.rechargeQrCodeImg) {
                elements.rechargeQrCodeImg.src = qrCodeUrl;
            }

            goToRechargeStep(3);
        }

        async function submitDepositRequest() {
            if (!currentUser) return;
            const utr = elements.rechargeUtrInput.value.trim();
            if (!utr) {
                showStatusMessage(elements.rechargeStep3Status, "Please enter the UTR/Transaction ID.", 'warning');
                return;
            }
            elements.rechargeSubmitBtn.disabled = true;
            elements.rechargeSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';
            showGlobalLoader(true, true);

            
            const depositRequest = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userName: userProfile.displayName || 'N/A',
                amount: currentRechargeData.amount,
                paymentMethod: currentRechargeData.paymentMethod,
                upiId: currentRechargeData.upiId,
                utr: utr,
                status: 'pending', 
                timestamp: serverTimestamp()
            };

            try {
                
                
                const depositsRef = ref(db, 'deposits');
                await push(depositsRef, depositRequest);

                
                alert("Deposit request submitted successfully! Your balance will be updated after verification by our team.");
                showSection('wallet-section');

            } catch (error) {
                console.error("Error submitting deposit request:", error);
                showStatusMessage(elements.rechargeStep3Status, `Failed to submit request. Error: ${error.message}`, 'danger', false);
            } finally {
                showGlobalLoader(false);
                elements.rechargeSubmitBtn.disabled = false;
                elements.rechargeSubmitBtn.innerHTML = 'Submit';
            }
        }

        function handleJoinTournamentClick(event) {
            if (!currentUser) { alert("Login to join."); showSection('login-section'); return; }
            const btn = event.currentTarget;
            const tId = btn.dataset.tournamentId;
            const fee = parseFloat(btn.dataset.fee || 0);
            const mode = btn.dataset.mode || 'Solo';

            if (!tId) return;

            elements.joinTournamentIdInput.value = tId;
            elements.joinTournamentFeeInput.value = fee;
            elements.joinTournamentModeInput.value = mode;

            
            elements.joinUsernameInput.value = userProfile.username || '';
            elements.joinGameUidInput.value = userProfile.gameUid || '';
            elements.joinTeammateUsernameInput.value = '';
            elements.joinTeammateGameUidInput.value = '';
            clearStatusMessage(elements.joinTournamentStatusMessage);

            if (mode === 'Duo') {
                const totalFee = fee * 2;
                elements.joinFeeDisplayEl.textContent = `NPR.${totalFee.toFixed(2)} (NPR.${fee} per player)`;
                elements.joinDuoFieldsContainer.style.display = 'block';
                elements.joinTeammateUsernameInput.required = true;
                elements.joinTeammateGameUidInput.required = true;
            } else {
                elements.joinFeeDisplayEl.textContent = `NPR.${fee.toFixed(2)}`;
                elements.joinDuoFieldsContainer.style.display = 'none';
                elements.joinTeammateUsernameInput.required = false;
                elements.joinTeammateGameUidInput.required = false;
            }

            elements.joinTournamentDetailsModalInstance.show();
        }

        async function confirmAndJoinTournament() {
             const tId = elements.joinTournamentIdInput.value;
             const singleFee = parseFloat(elements.joinTournamentFeeInput.value);
             const mode = elements.joinTournamentModeInput.value;
             const username = elements.joinUsernameInput.value.trim();
             const gameUid = elements.joinGameUidInput.value.trim();

             const teammateUsername = elements.joinTeammateUsernameInput.value.trim();
             const teammateGameUid = elements.joinTeammateGameUidInput.value.trim();

             const totalFee = (mode === 'Duo') ? singleFee * 2 : singleFee;

             if (!username || !gameUid) {
                 showStatusMessage(elements.joinTournamentStatusMessage, 'Your Player Username and Game UID are required.', 'warning');
                 return;
             }
             if (mode === 'Duo' && (!teammateUsername || !teammateGameUid)) {
                showStatusMessage(elements.joinTournamentStatusMessage, "Teammate's Username and UID are required for Duo mode.", 'warning');
                return;
             }

             clearStatusMessage(elements.joinTournamentStatusMessage);

             const btn = elements.confirmJoinBtn;
             btn.disabled = true;
             btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...';

             const uRef = ref(db, `users/${currentUser.uid}`);
             let tData = null;
             let transactionResult = null;

             try {
                 transactionResult = await runTransaction(uRef, (profileData) => {
                     if (!profileData) throw new Error("User profile missing.");

                     const deposit = profileData.depositBalance || 0;
                     const winnings = profileData.winningCash || 0;
                     const spendable = deposit + winnings;

                     if (spendable < totalFee) {
                         throw new Error(`Insufficient balance. You need NPR.${totalFee.toFixed(2)}, but have NPR.${spendable.toFixed(2)}.`);
                     }
                     if (profileData.joinedTournaments?.[tId]) { return; /* Abort transaction, already joined */ }

                     let feeDeductedFromDeposit = 0;
                     let feeDeductedFromWinnings = 0;

                     if (deposit >= totalFee) {
                         feeDeductedFromDeposit = totalFee;
                     } else {
                         feeDeductedFromDeposit = deposit;
                         feeDeductedFromWinnings = totalFee - deposit;
                     }

                     profileData.depositBalance = deposit - feeDeductedFromDeposit;
                     profileData.winningCash = winnings - feeDeductedFromWinnings;

                     if (!profileData.joinedTournaments) profileData.joinedTournaments = {};
                     profileData.joinedTournaments[tId] = true;
                     profileData.username = username;
                     profileData.gameUid = gameUid;
                     return profileData;
                 });

                 if (!transactionResult.committed) { throw new Error("Join failed. You may have already joined or balance is insufficient."); }

                 const tRef = ref(db, `tournaments/${tId}`);
                 const snapshot = await get(tRef);
                 if (!snapshot.exists()) throw new Error("Tournament not found after transaction.");
                 tData = snapshot.val();
                 if (tData.status !== 'upcoming') throw new Error("Tournament registration is closed.");
                 const rC = tData.registeredPlayers ? Object.keys(tData.registeredPlayers).length : 0;
                 if (tData.maxPlayers > 0 && rC >= tData.maxPlayers) throw new Error("Tournament is full.");

                 const updates = {};
                 const registrationData = {
                     joinedAt: serverTimestamp(),
                     username: username,
                     gameUid: gameUid
                 };

                 if (mode === 'Duo') {
                     registrationData.teammateUsername = teammateUsername;
                     registrationData.teammateGameUid = teammateGameUid;
                 }

                 updates[`tournaments/${tId}/registeredPlayers/${currentUser.uid}`] = registrationData;
                 await update(ref(db), updates);

                 await recordTransaction(currentUser.uid, 'tournament_join', -totalFee, `Joined: ${tData.name || 'Tournament'}`, { tournamentId: tId });
                 alert(`Joined successfully! NPR.${totalFee.toFixed(2)} deducted.`);

                 elements.joinTournamentDetailsModalInstance.hide();
                 if (currentSectionId === 'home-section') loadMyContests();
                 if (currentSectionId === 'tournaments-section' && currentTournamentGameId) {
                     const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                     filterTournaments(currentTournamentGameId, activeTab);
                 }
                 if (currentSectionId === 'wallet-section') loadRecentTransactions();

             } catch (e) {
                 console.error("Join failed:", e);
                 showStatusMessage(elements.joinTournamentStatusMessage, `Failed: ${e.message}`, 'danger', false);

                 if (transactionResult?.committed) {
                     console.error("CRITICAL: Balance deducted but failed to update tournament registration! Attempting refund.");
                     try {
                         await runTransaction(uRef, (profileData) => {
                             if (profileData) {
                                 
                                 profileData.depositBalance = (profileData.depositBalance || 0) + totalFee;
                                 delete profileData.joinedTournaments[tId];
                             }
                             return profileData;
                         });
                         await recordTransaction(currentUser.uid, 'join_failed_refund', totalFee, `Refund Failed Join: ${tData?.name || 'Tournament'}`);
                         alert("Join failed, but your balance was refunded.");
                     } catch (refundError) {
                         console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError);
                         alert(`Join failed. CRITICAL: Failed to refund balance (NPR.${totalFee.toFixed(2)})! Contact support immediately.`);
                     }
                 }
             } finally {
                 btn.disabled = false;
                 btn.innerHTML = 'Confirm & Join';
             }
        }

        async function loadAndDisplayNotifications() {
            if (!currentUser) return;
            const listEl = elements.notificationsListEl;
            const badgeEl = elements.notificationBadge;
            const emptyMsgEl = elements.notificationsEmptyMsgEl;

            listEl.innerHTML = '';
            badgeEl.style.display = 'none';
            emptyMsgEl.style.display = 'none';

            try {
                const globalNotifRef = ref(db, 'notifications');
                const userNotifRef = ref(db, `users/${currentUser.uid}/notifications`);

                const [globalSnapshot, userSnapshot] = await Promise.all([ get(globalNotifRef), get(userNotifRef) ]);

                let allNotifications = [];
                if (globalSnapshot.exists()) allNotifications.push(...Object.values(globalSnapshot.val()));
                if (userSnapshot.exists()) allNotifications.push(...Object.values(userSnapshot.val()));

                if (allNotifications.length === 0) { emptyMsgEl.style.display = 'block'; return; }

                allNotifications.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                let unreadCount = 0;
                const lastChecked = userProfile.lastCheckedNotifications || 0;
                let notificationsHtml = '';

                allNotifications.forEach(notif => {
                    const isUnread = notif.timestamp > lastChecked;
                    if (isUnread) unreadCount++;
                    notificationsHtml += createNotificationItemHTML(notif, isUnread);
                });

                listEl.innerHTML = notificationsHtml;
                if (unreadCount > 0) {
                    badgeEl.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badgeEl.style.display = 'flex';
                }
            } catch (error) {
                console.error("Error loading notifications:", error);
                listEl.innerHTML = '<p class="text-danger text-center">Could not load notifications.</p>';
            }
        }

        function createNotificationItemHTML(notification, isUnread) {
            return `
                <div class="notification-item">
                    ${isUnread ? '<span class="unread-indicator"></span>' : ''}
                    ${notification.imageUrl ? `<img src="${notification.imageUrl}" class="notification-item-img" alt="Notification Image">` : ''}
                    <div class="notification-item-content">
                        <div class="notification-item-title">${notification.title || 'Notification'}</div>
                        <div class="notification-item-message">${notification.message || ''}</div>
                        <div class="notification-item-time">${formatDate(notification.timestamp)}</div>
                    </div>
                </div>`;
        }

        async function markNotificationsAsRead() {
            if (!currentUser) return;
            const userRef = ref(db, `users/${currentUser.uid}`);
            try {
                await update(userRef, { lastCheckedNotifications: serverTimestamp() });
                console.log("Marked notifications as read.");
                elements.notificationBadge.style.display = 'none';
                elements.notificationsListEl.querySelectorAll('.unread-indicator').forEach(indicator => indicator.remove());
            } catch (error) { console.error("Failed to mark notifications as read:", error); }
        }

        function openNotificationsModal() {
            if (!currentUser) return;
            elements.notificationsModalInstance.show();
            markNotificationsAsRead();
        }

        function handleContactUs() {
            if (!currentUser) { alert("Please login to contact us."); return; }
            const contactNumber = appSettings.supportContact || '9389660753';
            const userName = userProfile.displayName || "a user";
            const message = `Hello Sir I Am ${userName} I need your help.`;
            const whatsappUrl = `https://wa.me/${contactNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function loadMatchHistory() {
            if (!currentUser || !elements.matchHistoryModalInstance) return;

            elements.matchHistoryBodyEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div><p class="mt-2 text-secondary">Loading history...</p></div>';
            elements.matchHistoryModalInstance.show();

            try {
                const historyRef = ref(db, `users/${currentUser.uid}/matchHistory`);
                const snapshot = await get(historyRef);

                if (!snapshot.exists()) {
                    elements.matchHistoryBodyEl.innerHTML = '<p class="text-center text-secondary p-4">You haven\'t played any matches yet.</p>';
                    return;
                }

                const historyData = snapshot.val();
                const sortedHistory = Object.values(historyData).sort((a,b) => (b.date || 0) - (a.date || 0));

                let historyHtml = '';
                sortedHistory.forEach(match => {
                    historyHtml += `
                     <div class="custom-card">
                         <h5 class="tournament-card-title mb-2">${match.tournamentName || 'Tournament'}</h5>
                         <p class="small text-secondary mb-3">${formatFullDateTime(match.date)}</p>
                         <div class="d-flex justify-content-around text-center">
                            <div><span class="text-secondary small d-block">Rank</span><strong class="h5">#${match.rank || 'N/A'}</strong></div>
                            <div><span class="text-secondary small d-block">Kills</span><strong class="h5">${match.kills ?? 'N/A'}</strong></div>
                            <div><span class="text-secondary small d-block">Winnings</span><strong class="h5 text-success">NPR.${(match.earnings || 0).toFixed(2)}</strong></div>
                         </div>
                     </div>
                    `;
                });
                elements.matchHistoryBodyEl.innerHTML = historyHtml;

            } catch (error) {
                 console.error("Error loading match history:", error);
                 elements.matchHistoryBodyEl.innerHTML = `<p class="text-center text-danger p-4">Could not load match history. Error: ${error.message}</p>`;
            }
        }

        
        async function loadTransactionHistory() {
            if (!currentUser || !elements.transactionHistoryModalInstance) return;

            elements.transactionHistoryBodyEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div><p class="mt-2 text-secondary">Loading transactions...</p></div>';
            elements.transactionHistoryModalInstance.show();

            try {
                const transactionsRef = ref(db, `transactions/${currentUser.uid}`);
                const snapshot = await get(transactionsRef);

                if (!snapshot.exists()) {
                    elements.transactionHistoryBodyEl.innerHTML = '<p class="text-center text-secondary p-4">You have no transaction history yet.</p>';
                    return;
                }

                const transactionsData = snapshot.val();
                const sortedTransactions = Object.values(transactionsData).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                let historyHtml = '';
                sortedTransactions.forEach(trx => {
                    const isCredit = trx.amount > 0;
                    const amountClass = isCredit ? 'text-success' : 'text-danger';
                    const amountSign = isCredit ? '+' : '';
                    const iconClass = isCredit ? 'bi-arrow-down-circle-fill text-success' : 'bi-arrow-up-circle-fill text-danger';

                    historyHtml += `
                        <div class="custom-card d-flex align-items-center p-3 mb-2">
                            <div class="me-3">
                                <i class="bi ${iconClass}" style="font-size: 2rem;"></i>
                            </div>
                            <div class="flex-grow-1">
                                <p class="mb-0 fw-bold" style="font-size: 1.0rem; color: var(--text-primary);">${trx.description || 'Transaction'}</p>
                                <p class="mb-0" style="font-size: 0.65rem; color: var(--text-secondary);">${formatFullDateTime(trx.timestamp)}</p>
                            </div>
                            <div class="ms-3 text-end">
                                <strong class="fs-5 ${amountClass}">${amountSign}<span class="currency-symbol">NPR.</span>${Math.abs(trx.amount || 0).toFixed(2)}</strong>
                            </div>
                        </div>
                    `;
                });
                elements.transactionHistoryBodyEl.innerHTML = historyHtml;

            } catch (error) {
                 console.error("Error loading transaction history:", error);
                 elements.transactionHistoryBodyEl.innerHTML = `<p class="text-center text-danger p-4">Could not load transaction history. Error: ${error.message}</p>`;
            }
        }

        function openTournamentChat(tournamentId, tournamentName) {
            if (!currentUser || !elements.tournamentChatModalInstance) return;

            if (currentChatListener) {
                off(currentChatListener.ref, 'child_added', currentChatListener.func);
                currentChatListener = null;
                console.log("Detached previous chat listener.");
            }

            elements.tournamentChatModalTitle.textContent = tournamentName;
            elements.chatForm.dataset.tournamentId = tournamentId;
            elements.chatMessagesEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div></div>';
            elements.tournamentChatModalInstance.show();

            const chatRef = query(ref(db, `chats/${tournamentId}`), limitToLast(50));
            const messages = [];
            currentChatListener = {
                 ref: chatRef,
                 func: onChildAdded(chatRef, (snapshot) => {
                    if (elements.chatMessagesEl.querySelector('.spinner-border')) {
                        elements.chatMessagesEl.innerHTML = '';
                    }
                    const msg = snapshot.val();
                    if(msg) {
                        appendChatMessage(msg, true, elements.chatMessagesEl);
                    }
                }, { onlyOnce: false })
            };
        }

        function cancelReply(){
            currentReply = null;
            elements.chatReplyContextEl.style.display = 'none';
        }

        function appendChatMessage(msg, prepend = false, containerEl) {
            const isMyMessage = msg.uid === currentUser.uid;
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isMyMessage ? 'my-message' : 'other-message'}`;
            bubble.dataset.senderName = msg.displayName;
            bubble.dataset.messageText = msg.message;

            let replyHtml = '';
            if (msg.replyTo) {
                 replyHtml = `
                     <div class="reply-quote-block">
                        <span class="sender-name">${msg.replyTo.originalSenderName}</span>
                        <p>${msg.replyTo.originalMessage}</p>
                     </div>
                 `;
            }

            bubble.innerHTML = `
                ${replyHtml}
                ${!isMyMessage ? `<span class="sender-name">${msg.displayName || 'User'}</span>` : ''}
                ${msg.message}
                <span class="msg-time">${formatFullDateTime(msg.timestamp)}</span>
            `;

            if(prepend){
                 containerEl.prepend(bubble);
            } else {
                 containerEl.appendChild(bubble);
                 containerEl.scrollTop = 0;
            }
        }

        async function handleChatSubmit(event) {
            event.preventDefault();
            const tournamentId = event.currentTarget.dataset.tournamentId;
            const messageText = elements.chatMessageInput.value.trim();

            if (!messageText || !tournamentId || !currentUser) return;

            const tRef = ref(db, `tournaments/${tournamentId}`);
            const tSnap = await get(tRef);
            if (!tSnap.exists() || !tSnap.val().registeredPlayers?.[currentUser.uid]) {
                alert("You can only chat in tournaments you have joined.");
                return;
            }

            const messageData = {
                uid: currentUser.uid,
                displayName: userProfile.displayName,
                message: messageText,
                timestamp: serverTimestamp()
            };

            if (currentReply) {
                 messageData.replyTo = currentReply;
            }

            try {
                await push(ref(db, `chats/${tournamentId}`), messageData);
                elements.chatMessageInput.value = '';
                cancelReply();
            } catch(error) {
                console.error("Error sending chat message:", error);
                alert(`Could not send message: ${error.message}`);
            }
        }

        function openEditNameModal() {
            if (!currentUser) return;
            elements.editNameInput.value = userProfile.displayName || '';
            clearStatusMessage(elements.editNameStatusMessage);
            elements.editNameModalInstance.show();
        }

        async function saveNameChange() {
            const newName = elements.editNameInput.value.trim();
            if (!newName) {
                showStatusMessage(elements.editNameStatusMessage, "Name cannot be empty.", "warning");
                return;
            }
            if (newName === userProfile.displayName) {
                elements.editNameModalInstance.hide();
                return;
            }

            showGlobalLoader(true, true); 
            const userRef = ref(db, `users/${currentUser.uid}`);
            try {
                await update(userRef, { displayName: newName });
                userProfile.displayName = newName; 
                populateUserInfo(currentUser, userProfile); 
                elements.editNameModalInstance.hide();
            } catch (error) {
                console.error("Error updating name:", error);
                showStatusMessage(elements.editNameStatusMessage, `Error: ${error.message}`, "danger", false);
            } finally {
                showGlobalLoader(false);
            }
        }

        
        // NEW: Live Support Functions (Corrected to prevent message duplication)
        function openLiveSupportChat() {
            if (!currentUser) {
                alert("Please login to use live support.");
                return;
            }

            if (currentLiveChatUnsubscribe) {
                currentLiveChatUnsubscribe();
                currentLiveChatUnsubscribe = null;
            }
            if (adminStatusUnsubscribe) {
                adminStatusUnsubscribe();
                adminStatusUnsubscribe = null;
            }
            
            outgoingLiveChatMessages.clear();
            showSection('live-support-section');
            elements.liveChatMessagesEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div><p class="mt-2">Connecting to support...</p></div>';

            const adminStatusRef = ref(db, 'settings/adminStatus');
            adminStatusUnsubscribe = onValue(adminStatusRef, (snapshot) => {
                const status = snapshot.val() || 'offline';
                const indicatorEl = elements.adminStatusIndicator;
                const statusTextEl = indicatorEl.querySelector('.admin-status-text');

                if (status === 'online') {
                    indicatorEl.className = 'admin-status online';
                    statusTextEl.textContent = 'Online';
                } else {
                    indicatorEl.className = 'admin-status offline';
                    statusTextEl.textContent = 'Offline';
                }
            });

            const chatRef = query(ref(db, `liveSupportChats/${currentUser.uid}`), limitToLast(100));

            currentLiveChatUnsubscribe = onChildAdded(chatRef, (messageSnapshot) => {
                // FIX:  innerHTML     ,   (spinner  "start conversation" )  
                const spinner = elements.liveChatMessagesEl.querySelector('.spinner-border');
                if (spinner) {
                    spinner.parentElement.innerHTML = '';
                }
                const placeholder = elements.liveChatMessagesEl.querySelector('p.text-secondary');
                if (placeholder) {
                    placeholder.parentElement.innerHTML = '';
                }
                
                if (outgoingLiveChatMessages.has(messageSnapshot.key)) {
                    const existingElement = document.getElementById(messageSnapshot.key);
                    if (existingElement) {
                        const timeEl = existingElement.querySelector('.msg-time-live');
                        if(timeEl) timeEl.textContent = formatFullDateTime(messageSnapshot.val().timestamp);
                    }
                    outgoingLiveChatMessages.delete(messageSnapshot.key);
                    return;
                }

                const msg = messageSnapshot.val();
                if (msg) {
                    appendLiveChatMessage(msg, true, messageSnapshot.key);
                }
            });

            get(chatRef).then(snapshot => {
                if (!snapshot.exists()) {
                    elements.liveChatMessagesEl.innerHTML = '<p class="text-center text-secondary p-4">Start the conversation by sending a message.</p>';
                }
            }).catch(error => {
                console.error("Error checking for empty live chat:", error);
                elements.liveChatMessagesEl.innerHTML = '<p class="text-danger text-center">Failed to load chat.</p>';
            });
        }

        function appendLiveChatMessage(msg, prepend = false, messageKey = null) {
            const isUserMessage = msg.sender === 'user';
            const bubble = document.createElement('div');

            if (messageKey) {
                bubble.id = messageKey;
            }
            
            const adminInfo = appSettings.liveSupportAdmin || {
                displayName: 'Admin',
                photoURL: 'https://via.placeholder.com/35'
            };

            if (isUserMessage) {
                bubble.className = 'chat-bubble-live user-message';
                bubble.innerHTML = `
                    ${msg.message}
                    <span class="msg-time-live">${formatFullDateTime(msg.timestamp)}</span>
                `;
            } else {
                bubble.className = 'chat-bubble-live admin-message';
                bubble.innerHTML = `
                    <img src="${adminInfo.photoURL}" alt="Admin" class="admin-avatar">
                    <div class="admin-message-content">
                        <span class="admin-name">${adminInfo.displayName}</span>
                        ${msg.message}
                        <span class="msg-time-live">${formatFullDateTime(msg.timestamp)}</span>
                    </div>
                `;
            }

            if (prepend) {
                elements.liveChatMessagesEl.prepend(bubble);
            } else {
                elements.liveChatMessagesEl.appendChild(bubble);
                elements.liveChatMessagesEl.scrollTop = 0;
            }
        }

        async function handleLiveChatSubmit(event) {
            event.preventDefault();
            const messageText = elements.liveChatMessageInput.value.trim();

            if (!messageText || !currentUser) return;

            elements.liveChatMessageInput.value = '';
            
            if (elements.liveChatMessagesEl.querySelector('p.text-secondary')) {
                elements.liveChatMessagesEl.innerHTML = '';
             }

            const chatRef = ref(db, `liveSupportChats/${currentUser.uid}`);
            
            const firebaseMessageData = {
                sender: 'user',
                message: messageText,
                timestamp: serverTimestamp(),
                username: userProfile.displayName || 'N/A',
                email: currentUser.email || 'N/A'
            };

            try {
                const newMessageRef = push(chatRef);
                const messageKey = newMessageRef.key;

                outgoingLiveChatMessages.add(messageKey);

                const optimisticMessageData = {
                    sender: 'user',
                    message: messageText,
                    timestamp: Date.now()
                };
                
                //  FIX: 'false'  'true'     
                //     () 
                appendLiveChatMessage(optimisticMessageData, true, messageKey);

                await set(newMessageRef, firebaseMessageData);
            } catch (error) {
                console.error("Error sending live support message:", error);
                alert(`Could not send your message. Please try again. Error: ${error.message}`);
                const failedElement = document.getElementById(messageKey);
                if(failedElement) failedElement.remove();
                outgoingLiveChatMessages.delete(messageKey);
            }
        }
        
        
        function openChangePasswordModal() {
            if (!currentUser) return;
            getElement('changePasswordForm').reset();
            clearStatusMessage(elements.changePasswordStatusMessage);
            elements.changePasswordModalInstance.show();
        }

        async function handleChangePasswordSubmit() {
            if (!currentUser) return;

            const statusEl = elements.changePasswordStatusMessage;
            const currentPasswordEl = elements.currentPasswordInput;
            const newPasswordEl = elements.newPasswordInput;
            const confirmPasswordEl = elements.confirmNewPasswordInput;

            
            if (!currentPasswordEl.value) {
                showStatusMessage(statusEl, "Please enter your current password.", 'warning');
                return;
            }
            if (!newPasswordEl.value) {
                showStatusMessage(statusEl, "Please enter a new password.", 'warning');
                return;
            }
            if (newPasswordEl.value.length < 6) {
                showStatusMessage(statusEl, "New password must be at least 6 characters long.", 'warning');
                return;
            }
            if (!confirmPasswordEl.value) {
                showStatusMessage(statusEl, "Please confirm your new password.", 'warning');
                return;
            }
            if (newPasswordEl.value !== confirmPasswordEl.value) {
                showStatusMessage(statusEl, "New passwords do not match.", 'warning');
                return;
            }
            
            const btn = elements.savePasswordChangeBtn;
            toggleButtonLoader(btn, true, 'Saving...');
            clearStatusMessage(statusEl);

            try {
                
                const credential = EmailAuthProvider.credential(currentUser.email, currentPasswordEl.value);
                await reauthenticateWithCredential(currentUser, credential);
                
                
                await updatePassword(currentUser, newPasswordEl.value);
                
                showStatusMessage(statusEl, "Password changed successfully!", 'success');
                setTimeout(() => {
                    elements.changePasswordModalInstance.hide();
                }, 2000);

            } catch (error) {
                console.error("Password change error:", error);
                let message = "Your Current Password Is Wrong.";
                switch (error.code) {
                    case 'auth/wrong-password':
                        message = "Incorrect current password. Please try again.";
                        break;
                    case 'auth/weak-password':
                        message = "The new password is too weak.";
                        break;
                    case 'auth/too-many-requests':
                        message = "Too many attempts. Please try again later.";
                        break;
                }
                showStatusMessage(statusEl, message, 'danger');
            } finally {
                toggleButtonLoader(btn, false);
            }
        }

        
        
        function openMyStatsModal() {
            if (!currentUser || !elements.myStatsModalInstance) return;

            
            elements.statsMatchesPlayed.textContent = userProfile.totalMatches || 0;
            elements.statsMatchesWon.textContent = userProfile.wonMatches || 0;
            elements.statsTotalKills.textContent = userProfile.totalKills || 0; 
            elements.statsTotalWinnings.textContent = `NPR.${(userProfile.totalEarnings || 0).toFixed(2)}`;
            elements.statsReferralEarnings.textContent = `NPR.${(userProfile.referralEarnings || 0).toFixed(2)}`;

            
            elements.statsCardContainer.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));

            elements.myStatsModalInstance.show();
        }

        function handleStatCardClick(event) {
            const clickedCard = event.currentTarget;
            
            elements.statsCardContainer.querySelectorAll('.stat-card').forEach(card => {
                if (card !== clickedCard) {
                    card.classList.remove('active');
                }
            });
            
            clickedCard.classList.toggle('active');
        }

        // ======================================================
        // =========== NEW PROMO CODE FUNCTIONS START ===========
        // ======================================================

        function showPromoCodeOverlay() {
            if (!elements.promoCodeOverlay) return;
            elements.promoCodeInput.value = '';
            elements.promoCodeStatusMessage.textContent = '';
            elements.promoCodeStatusMessage.className = 'promo-code-status';
            elements.promoCodeOverlay.style.display = 'flex';
            setTimeout(() => elements.promoCodeOverlay.classList.add('visible'), 10);
        }

        function hidePromoCodeOverlay() {
            if (!elements.promoCodeOverlay) return;
            elements.promoCodeOverlay.classList.remove('visible');
            setTimeout(() => {
                elements.promoCodeOverlay.style.display = 'none';
            }, 300); // Match CSS transition duration
        }

                // ======================================================
        // =========== NEW/UPDATED PROMO CODE FUNCTION START ====
        // ======================================================

                async function redeemPromoCode() {
            if (!currentUser) return;

            const codeInput = elements.promoCodeInput.value.trim().toUpperCase();
            const statusEl = elements.promoCodeStatusMessage;

            if (!codeInput) {
                statusEl.textContent = 'Enter promo code';
                statusEl.className = 'promo-code-status text-danger';
                return;
            }

            toggleButtonLoader(elements.redeemPromoCodeBtn, true, 'Verifying...');
            statusEl.textContent = '';
            statusEl.className = 'promo-code-status';

            try {
                const promoCodesRef = ref(db, 'promoCodes');
                const q = query(promoCodesRef, orderByChild('code'), equalTo(codeInput));
                const snapshot = await get(q);

                if (!snapshot.exists()) {
                    throw new Error('Invalid promo code');
                }

                let promoKey;
                let promoData;
                snapshot.forEach(child => {
                    promoKey = child.key;
                    promoData = child.val();
                });

                if (!promoData.active) {
                    throw new Error('This promo code is not active.');
                }
                
                // <<< BADLAV 1: 'usesLeft' KI JAGAH 'usageLimit' CHECK HO RAHA HAI >>>
                if (promoData.usageLimit <= 0) {
                    throw new Error('This promo code has been fully used.');
                }
                if (promoData.usedBy && promoData.usedBy[currentUser.uid]) {
                    throw new Error('You have already used this promo code.');
                }
                if (promoData.expiryDate && new Date(promoData.expiryDate) < new Date()) {
                    throw new Error('This promo code has expired.');
                }

                const balanceType = promoData.balanceType || 'depositBalance';
                let balanceTypeName = "Deposit";

                const userRef = ref(db, `users/${currentUser.uid}`);
                await runTransaction(userRef, (profile) => {
                    if (profile) {
                        if (balanceType === 'winningCash') {
                            profile.winningCash = (profile.winningCash || 0) + promoData.amount;
                            balanceTypeName = "Winning";
                        } else if (balanceType === 'bonusCash') {
                            profile.bonusCash = (profile.bonusCash || 0) + promoData.amount;
                            balanceTypeName = "Bonus";
                        } else {
                            profile.depositBalance = (profile.depositBalance || 0) + promoData.amount;
                            balanceTypeName = "Deposit";
                        }
                    }
                    return profile;
                });

                const promoRef = ref(db, `promoCodes/${promoKey}`);
                
                // <<< BADLAV 2: 'usesLeft' KI JAGAH 'usageLimit' UPDATE HO RAHA HAI >>>
                const updates = {
                    usageLimit: (promoData.usageLimit || 1) - 1,
                    [`usedBy/${currentUser.uid}`]: true
                };
                await update(promoRef, updates);

                await recordTransaction(currentUser.uid, `promo_code_${balanceType}`, promoData.amount, `Promo (${balanceTypeName}): ${promoData.code}`);

                statusEl.textContent = `Success! NPR.${promoData.amount} added to your ${balanceTypeName} balance.`;
                statusEl.className = 'promo-code-status text-success';

                setTimeout(() => {
                    hidePromoCodeOverlay();
                }, 2000);

            } catch (error) {
                statusEl.textContent = error.message;
                statusEl.className = 'promo-code-status text-danger';
            } finally {
                toggleButtonLoader(elements.redeemPromoCodeBtn, false);
            }
        }

        // ====================================================
        // ============ NEW PROMO CODE FUNCTION END =============
        // ====================================================


        function initializeEventListeners() {
            if (!elements) return;
            console.log("Initializing listeners...");
            
            
            elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => {
                e.preventDefault();
                showSection(item.dataset.section);
            }));

            elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => {
                const s = e.currentTarget.dataset.status;
                if (currentTournamentGameId && s) {
                    elements.tournamentTabs.forEach(t => t.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    filterTournaments(currentTournamentGameId, s);
                }
            }));

            
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleAuthForm('emailSignupForm'));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleAuthForm('emailLoginForm'));
            elements.sendResetLinkBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                sendResetLink(elements.resetEmailInput, elements.resetStatusMessage);
            });
            elements.showLoginFromResetBtn?.addEventListener('click', () => toggleAuthForm('emailLoginForm'));

            
            elements.forgotPasswordLink?.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForm('forgotPasswordForm');
            });

            elements.logoutProfileBtn?.addEventListener('click', logoutUser);

            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));

            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', startRechargeFlow);
            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
            elements.rechargePresetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.rechargeAmountInput.value = btn.dataset.amount;
                });
            });
            elements.goToStep2Btn?.addEventListener('click', handleGoToStep2);
            elements.goToStep3Btn?.addEventListener('click', handleGoToStep3);
            elements.paymentOptionCards.forEach(card => {
                card.addEventListener('click', () => {
                    elements.paymentOptionCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    card.querySelector('input[type="radio"]').checked = true;
                });
            });
            elements.rechargeSubmitBtn?.addEventListener('click', submitDepositRequest);
            elements.rechargeCancelBtn?.addEventListener('click', () => window.history.back());
            elements.rechargeCopyAmtBtn?.addEventListener('click', () => copyToClipboard(currentRechargeData.amount.toString(), true));
            elements.rechargeCopyIDBtn?.addEventListener('click', () => copyToClipboard(currentRechargeData.upiId, true));
            elements.confirmJoinBtn?.addEventListener('click', confirmAndJoinTournament);

            elements.contactUsBtn?.addEventListener('click', (event) => {
                event.preventDefault(); 
                handleContactUs();
            });

            // --- MODIFIED CODE START ---
            // This button now opens the transaction history modal directly.
            elements.allTransactionsBtn?.addEventListener('click', loadTransactionHistory);
            // --- MODIFIED CODE END ---
            
            elements.notificationBtn?.addEventListener('click', openNotificationsModal);

            elements.editNameBtnEl?.addEventListener('click', openEditNameModal);
            elements.saveNameChangeBtn?.addEventListener('click', saveNameChange);

            elements.matchHistoryBtn?.addEventListener('click', (event) => {
                event.preventDefault(); 
                loadMatchHistory();
            });

            elements.transactionHistoryBtn?.addEventListener('click', (event) => {
                event.preventDefault(); 
                loadTransactionHistory();
            });

            
            elements.myStatsBtn?.addEventListener('click', (event) => {
                event.preventDefault();
                openMyStatsModal();
            });


            elements.changePasswordBtn?.addEventListener('click', (event) => {
                event.preventDefault();
                openChangePasswordModal();
            });

            elements.savePasswordChangeBtn?.addEventListener('click', handleChangePasswordSubmit);
            elements.chatForm?.addEventListener('submit', handleChatSubmit);
            elements.cancelReplyBtn?.addEventListener('click', cancelReply);

            // NEW: Live Support button listener
            elements.liveSupportBtn?.addEventListener('click', (event) => {
                event.preventDefault();
                openLiveSupportChat();
            });

            elements.liveChatForm?.addEventListener('submit', handleLiveChatSubmit);

            // NEW: Live Stream chat form listener
            elements.liveStreamChatForm?.addEventListener('submit', handleLiveStreamChatSubmit);

            // =========== NEW PROMO CODE LISTENERS ===========
            elements.promoCodeBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                showPromoCodeOverlay();
            });
            elements.closePromoCodeBtn?.addEventListener('click', hidePromoCodeOverlay);
            elements.redeemPromoCodeBtn?.addEventListener('click', redeemPromoCode);


            document.querySelectorAll('.password-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordInput = e.currentTarget.closest('.input-group-wrapper').querySelector('input');
                    const icon = e.currentTarget.querySelector('i');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('bi-eye-slash');
                        icon.classList.add('bi-eye');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('bi-eye');
                        icon.classList.add('bi-eye-slash');
                    }
                });
            });

            elements.chatMessagesEl.addEventListener('click', (e) => {
                const bubble = e.target.closest('.chat-bubble');
                if (!bubble) return;
                const sender = bubble.dataset.senderName;
                let message = bubble.dataset.messageText;
                if (message.length > 50) message = message.substring(0, 50) + '...';
                currentReply = {
                    originalSenderName: sender,
                    originalMessage: message
                };
                elements.replyToNameEl.textContent = sender;
                elements.replyToMessageEl.textContent = message;
                elements.chatReplyContextEl.style.display = 'block';
            });

            getElement('tournamentChatModal')?.addEventListener('hidden.bs.modal', () => {
                if (currentChatListener && currentChatListener.ref) {
                    off(currentChatListener.ref, 'child_added', currentChatListener.func);
                    currentChatListener = null;
                    console.log('Detached chat listener.');
                }
                cancelReply();
            });

            
            if (elements.statsCardContainer) {
                elements.statsCardContainer.querySelectorAll('.stat-card').forEach(card => {
                    card.addEventListener('click', handleStatCardClick);
                });
            }

            
            if (elements.myStatsModalInstance) {
                getElement('myStatsModal').addEventListener('click', (event) => {
                    
                    if (event.target === getElement('myStatsModal') || event.target === getElement('myStatsModal').querySelector('.modal-dialog')) {
                        elements.statsCardContainer.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
                    }
                });
            }

            document.body.addEventListener('click', (event) => {
                if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) {
                    const btn = event.target.closest('.copy-btn');
                    const targetSelector = btn.dataset.target;
                    if (targetSelector) {
                        copyToClipboard(targetSelector);
                    }
                }
                if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) {
                    const cel = getElement('referralCodeDisplay');
                    if (cel) shareReferral(cel.textContent);
                }
            });

            console.log("Listeners initialized.");
        }

        // NEW CODE - Function to preload the login logo
        /**
         * Preloads essential assets for the login screen while the main loader is visible.
         */
        function preloadLoginAssets() {
            console.log("Preloading login assets...");
            // The URL of the logo from your HTML
            const loginLogoUrl = "https://i.ibb.co/LdPZtH5/ninja-logo.png";
            // Create a new image object in memory
            const img = new Image();
            // Setting the 'src' tells the browser to start downloading it
            img.src = loginLogoUrl;
        }

         document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Loaded. Init App...");
             // NEW CODE - Call the preloading function as soon as the DOM is ready
             preloadLoginAssets();

             if (typeof initializeApp !== 'function' || !auth || !db) { console.error("Firebase SDK failed/not ready. Cannot proceed."); return; }
             
             showGlobalLoader(true); 
             loadAppSettings()
                 .then(() => {
                     initializeEventListeners();
                     updateGlobalUI(false);
                     onAuthStateChanged(auth, handleAuthStateChange);
                 })
                 .catch(err => {
                     console.error("CRITICAL: Initial settings load failed:", err);
                     alert("Error loading essential app settings. Please try again later.");
                     initializeEventListeners();
                     updateGlobalUI(false);
                     onAuthStateChanged(auth, handleAuthStateChange);
                 });
         });

         
        function initializeAudio() {
            const backgroundMusic = document.getElementById('backgroundMusic');
            const clickSound = document.getElementById('clickSound');

            if (backgroundMusic && clickSound) {
                backgroundMusic.volume = 0.4;
                clickSound.volume = 0.2;

                const playBackgroundMusic = async () => {
                    try {
                        if (backgroundMusic.paused) await backgroundMusic.play();
                    } catch (error) {
                        console.log("Music autoplay was blocked. Waiting for user interaction.");
                        const startAudio = () => {
                            backgroundMusic.play().catch(e => console.log("BG music error after interaction:", e));
                            document.removeEventListener('click', startAudio);
                            document.removeEventListener('touchstart', startAudio);
                        };
                        document.addEventListener('click', startAudio, { once: true });
                        document.addEventListener('touchstart', startAudio, { once: true });
                    }
                };
                playBackgroundMusic();

                document.body.addEventListener('click', (event) => {
                    if (event.target.closest('button, a, .game-card, .interactive-list-item')) {
                        clickSound.currentTime = 0;
                        clickSound.play().catch(e => console.log("Click sound error:", e));
                    }
                });
            }
        }
        

</script>

</body>
</html>